{% extends "base.html" %}

{% block title %}지원서 상세{% endblock %}

{% block content %}
<div class="page-header">
    <h2>지원서 상세</h2>
    <div class="actions">
        <button onclick="history.back()" class="btn btn-secondary">목록으로</button>
        {% if user.role == 'admin' %}
        <button onclick="deleteApplication()" class="btn btn-danger">삭제</button>
        {% endif %}
    </div>
</div>

<div id="application-detail" class="detail-container">
    <!-- 로딩 중 -->
    <div class="loading">데이터를 불러오는 중...</div>
</div>

<script>
const applicationId = {{ application_id }};

// 애플리케이션 데이터 로드
async function loadApplicationDetail() {
    const container = document.getElementById('application-detail');
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load application');
        }
        
        const app = await response.json();
        
        // AI 카테고리 파싱
        let aiCategories = [];
        if (app.ai_categories) {
            try {
                aiCategories = typeof app.ai_categories === 'string' 
                    ? JSON.parse(app.ai_categories) 
                    : app.ai_categories;
            } catch (e) {
                console.error('AI categories parsing error:', e);
            }
        }
        
        // AI 평가 상세 파싱
        let aiEvaluationDetail = {};
        if (app.ai_evaluation_detail) {
            try {
                aiEvaluationDetail = typeof app.ai_evaluation_detail === 'string'
                    ? JSON.parse(app.ai_evaluation_detail)
                    : app.ai_evaluation_detail;
            } catch (e) {
                console.error('AI evaluation detail parsing error:', e);
            }
        }
        
        // 기술 역량 파싱
        let techCapabilities = {};
        if (app.tech_capabilities) {
            try {
                techCapabilities = typeof app.tech_capabilities === 'string'
                    ? JSON.parse(app.tech_capabilities)
                    : app.tech_capabilities;
            } catch (e) {
                console.error('Tech capabilities parsing error:', e);
            }
        }
        
        container.innerHTML = `
            <!-- 기본 정보 -->
            <div class="card">
                <h3>기본 정보</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>과제명</label>
                        <div>${app.subject || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>사업부</label>
                        <div>${app.division || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>부서</label>
                        <div>${app.department_name || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>참여 인원</label>
                        <div>${app.participant_count || '-'}명</div>
                    </div>
                    <div class="detail-item">
                        <label>대표자</label>
                        <div>${app.representative_name || '-'} (${app.representative_knox_id || '-'})</div>
                    </div>
                    <div class="detail-item">
                        <label>상태</label>
                        <div><span class="badge badge-${app.status}">${getStatusText(app.status)}</span></div>
                    </div>
                </div>
            </div>
            
            <!-- AI 평가 결과 -->
            <div class="card">
                <h3>AI 평가 결과</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>AI 등급</label>
                        <div><span class="badge badge-grade-${app.ai_grade || 'none'}">${app.ai_grade || '미평가'}</span></div>
                    </div>
                    <div class="detail-item">
                        <label>AI 기술 분류</label>
                        <div>
                            ${aiCategories.length > 0 
                                ? aiCategories.map(cat => `<span class="badge">${cat.category} (${Math.round(cat.confidence * 100)}%)</span>`).join(' ')
                                : '<span class="text-muted">분류되지 않음</span>'}
                        </div>
                    </div>
                    <div class="detail-item full-width">
                        <label>AI 요약</label>
                        <div>${app.ai_summary || '평가되지 않음'}</div>
                    </div>
                </div>
                
                ${aiEvaluationDetail.scores ? `
                <div class="evaluation-scores">
                    <h4>세부 평가 점수</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>평가 항목</th>
                                <th>점수</th>
                                <th>등급</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(aiEvaluationDetail.scores).map(([name, data]) => `
                                <tr>
                                    <td>${name}</td>
                                    <td>${data.score}/5</td>
                                    <td><span class="badge badge-grade-${data.grade}">${data.grade}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            </div>
            
            <!-- 과제 내용 -->
            <div class="card">
                <h3>과제 내용</h3>
                <div class="detail-item">
                    <label>현재 업무</label>
                    <div class="text-content">${app.current_work || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>Pain Point</label>
                    <div class="text-content">${app.pain_point || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>개선 아이디어</label>
                    <div class="text-content">${app.improvement_idea || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>기대 효과</label>
                    <div class="text-content">${app.expected_effect || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>바라는 점</label>
                    <div class="text-content">${app.hope || '-'}</div>
                </div>
            </div>
            
            <!-- 기술 역량 -->
            ${Object.keys(techCapabilities).length > 0 ? `
            <div class="card">
                <h3>기술 역량</h3>
                <div class="tech-capabilities">
                    ${Object.entries(techCapabilities).map(([key, value]) => `
                        <div class="tech-item">
                            <label>${key}</label>
                            <div>${value}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- 사용자 평가 -->
            <div class="card">
                <h3>심사위원 평가</h3>
                ${app.user_grade ? `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>등급</label>
                            <div><span class="badge badge-grade-${app.user_grade}">${app.user_grade}</span></div>
                        </div>
                        <div class="detail-item">
                            <label>평가자</label>
                            <div>${app.user_evaluated_by_name || '-'}</div>
                        </div>
                        <div class="detail-item full-width">
                            <label>코멘트</label>
                            <div>${app.user_comment || '-'}</div>
                        </div>
                    </div>
                ` : `
                    <p class="text-muted">아직 평가되지 않았습니다.</p>
                    ${(user.role === 'admin' || user.department_id === app.department_id) ? `
                        <button onclick="showEvaluationForm()" class="btn btn-primary">평가하기</button>
                    ` : ''}
                `}
            </div>
            
            <!-- 평가 폼 (숨김) -->
            <div id="evaluation-form" class="card" style="display: none;">
                <h3>평가 작성</h3>
                <form onsubmit="submitEvaluation(event)">
                    <div class="form-group">
                        <label for="grade">등급</label>
                        <select id="grade" name="grade" required>
                            <option value="">선택하세요</option>
                            <option value="S">S - 최우수</option>
                            <option value="A">A - 우수</option>
                            <option value="B">B - 양호</option>
                            <option value="C">C - 보통</option>
                            <option value="D">D - 미흡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comment">코멘트</label>
                        <textarea id="comment" name="comment" rows="5" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">평가 제출</button>
                        <button type="button" onclick="hideEvaluationForm()" class="btn btn-secondary">취소</button>
                    </div>
                </form>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading application:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                지원서를 불러오는 중 오류가 발생했습니다.
            </div>
        `;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': '대기',
        'ai_evaluated': 'AI 평가 완료',
        'user_evaluated': '심사 완료',
        'approved': '승인',
        'rejected': '반려'
    };
    return statusMap[status] || status;
}

function showEvaluationForm() {
    document.getElementById('evaluation-form').style.display = 'block';
}

function hideEvaluationForm() {
    document.getElementById('evaluation-form').style.display = 'none';
}

async function submitEvaluation(event) {
    event.preventDefault();
    
    const grade = document.getElementById('grade').value;
    const comment = document.getElementById('comment').value;
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}/evaluate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ grade, comment })
        });
        
        if (response.ok) {
            alert('평가가 제출되었습니다.');
            location.reload();
        } else {
            const error = await response.json();
            alert(`평가 제출 실패: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error submitting evaluation:', error);
        alert('평가 제출 중 오류가 발생했습니다.');
    }
}

async function deleteApplication() {
    if (!confirm('정말 이 지원서를 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('지원서가 삭제되었습니다.');
            window.location.href = '/applications';
        } else {
            const error = await response.json();
            alert(`삭제 실패: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting application:', error);
        alert('삭제 중 오류가 발생했습니다.');
    }
}

const user = {
    id: {{ user.id }},
    username: "{{ user.username }}",
    name: "{{ user.name }}",
    role: "{{ user.role }}"
};

// 페이지 로드 시 실행
loadApplicationDetail();
</script>

<style>
.detail-container {
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 16px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-item.full-width {
    grid-column: 1 / -1;
}

.detail-item label {
    font-weight: 600;
    color: #666;
    font-size: 14px;
}

.detail-item > div {
    font-size: 16px;
    color: #333;
}

.text-content {
    white-space: pre-wrap;
    line-height: 1.6;
    background: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
}

.tech-capabilities {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.tech-item {
    padding: 12px;
    background: #f5f5f5;
    border-radius: 4px;
}

.tech-item label {
    font-size: 12px;
    color: #666;
    display: block;
    margin-bottom: 4px;
}

.evaluation-scores {
    margin-top: 20px;
}

.evaluation-scores h4 {
    margin-bottom: 12px;
}

.badge-grade-S { background: #10b981; color: white; }
.badge-grade-A { background: #3b82f6; color: white; }
.badge-grade-B { background: #f59e0b; color: white; }
.badge-grade-C { background: #ef4444; color: white; }
.badge-grade-D { background: #6b7280; color: white; }
.badge-grade-none { background: #e5e7eb; color: #6b7280; }

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}
</style>
{% endblock %}
