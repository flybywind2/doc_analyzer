{% extends "base.html" %}

{% block title %}ì§€ì›ì„œ ìƒì„¸ - AI ê³¼ì œ ì§€ì›ì„œ í‰ê°€ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-gray-900">ì§€ì›ì„œ ìƒì„¸ ì •ë³´</h2>
        <div class="flex space-x-2">
            {% if user.role == 'admin' %}
            <button onclick="runAIEvaluation()" class="inline-flex items-center px-4 py-2 border border-purple-300 rounded-md shadow-sm text-sm font-medium text-purple-700 bg-white hover:bg-purple-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                <i class="fa-solid fa-robot mr-2"></i> AI ì¬í‰ê°€
            </button>
            <button onclick="showEditModal()" class="inline-flex items-center px-4 py-2 border border-blue-300 rounded-md shadow-sm text-sm font-medium text-blue-700 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                <i class="fa-solid fa-pen-to-square mr-2"></i> ê¸°ë³¸ì •ë³´ ìˆ˜ì •
            </button>
            {% endif %}
            <button onclick="history.back()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                <i class="fa-solid fa-arrow-left mr-2"></i> ëª©ë¡ìœ¼ë¡œ
            </button>
            {% if user.role == 'admin' %}
            <button onclick="deleteApplication()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                <i class="fa-solid fa-trash mr-2"></i> ì‚­ì œ
            </button>
            {% endif %}
        </div>
    </div>

    <div id="application-detail" class="space-y-6">
        <!-- ë¡œë”© ì¤‘ -->
        <div class="flex justify-center items-center py-20">
            <div class="text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500 text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>
</div>

<!-- ìˆ˜ì • ëª¨ë‹¬ -->
<div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-lg font-bold text-gray-900">ê¸°ë³¸ ì •ë³´ ìˆ˜ì •</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-500">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="edit-form" class="mt-4" onsubmit="handleUpdate(event)">
            <div class="space-y-4">
                <div>
                    <label for="edit-subject" class="block text-sm font-medium text-gray-700 mb-1">ê³¼ì œëª… *</label>
                    <input type="text" id="edit-subject" required class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-division" class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ì—…ë¶€</label>
                        <select id="edit-division" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2">
                            <option value="">ì‚¬ì—…ë¶€ ì„ íƒ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="edit-participant-count" class="block text-sm font-medium text-gray-700 mb-1">ì°¸ì—¬ ì¸ì›</label>
                        <input type="number" id="edit-participant-count" min="1" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-representative-name" class="block text-sm font-medium text-gray-700 mb-1">ëŒ€í‘œì ì´ë¦„</label>
                        <input type="text" id="edit-representative-name" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2">
                    </div>
                    
                    <div>
                        <label for="edit-representative-knox-id" class="block text-sm font-medium text-gray-700 mb-1">ëŒ€í‘œì Knox ID</label>
                        <input type="text" id="edit-representative-knox-id" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2">
                    </div>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    ì·¨ì†Œ
                </button>
                <button type="submit" id="submit-btn" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    ì €ì¥
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const applicationId = {{ application_id }};
let currentApplication = null;
let allEvaluations = [];
let currentUserEvaluation = null;
let allDepartments = [];

// ì• í”Œë¦¬ì¼€ì´ì…˜ ë°ì´í„° ë¡œë“œ
async function loadApplicationDetail() {
    const container = document.getElementById('application-detail');
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load application');
        }
        
        const app = await response.json();
        currentApplication = app; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        
        // AI ì¹´í…Œê³ ë¦¬ íŒŒì‹±
        let aiCategories = [];
        if (app.ai_categories) {
            try {
                aiCategories = typeof app.ai_categories === 'string' 
                    ? JSON.parse(app.ai_categories) 
                    : app.ai_categories;
            } catch (e) {
                console.error('AI categories parsing error:', e);
            }
        }
        
        // AI í‰ê°€ ìƒì„¸ íŒŒì‹±
        let aiEvaluationDetail = {};
        if (app.ai_evaluation_detail) {
            try {
                aiEvaluationDetail = typeof app.ai_evaluation_detail === 'string'
                    ? JSON.parse(app.ai_evaluation_detail)
                    : app.ai_evaluation_detail;
            } catch (e) {
                console.error('AI evaluation detail parsing error:', e);
            }
        }
        
        // ê¸°ìˆ  ì—­ëŸ‰ íŒŒì‹±
        let techCapabilities = [];
        if (app.tech_capabilities) {
            try {
                techCapabilities = typeof app.tech_capabilities === 'string'
                    ? JSON.parse(app.tech_capabilities)
                    : app.tech_capabilities;
            } catch (e) {
                console.error('Tech capabilities parsing error:', e);
            }
        }
        
        container.innerHTML = `
            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fa-solid fa-file-invoice text-blue-500 mr-2"></i> ê¸°ë³¸ ì •ë³´
                    </h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ê³¼ì œëª…</label>
                        <div class="text-base font-medium text-gray-900">${app.subject || '-'}</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ì‚¬ì—…ë¶€ / ë¶€ì„œ</label>
                        <div class="text-base text-gray-900">${app.division || '-'} / ${app.department_name || '-'}</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ì°¸ì—¬ ì¸ì›</label>
                        <div class="text-base text-gray-900">${app.participant_count || '-'}ëª…</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ëŒ€í‘œì</label>
                        <div class="text-base text-gray-900 flex items-center">
                            <span class="font-medium mr-1">${app.representative_name || '-'}</span>
                            <span class="text-gray-500 text-sm">(${app.representative_knox_id || '-'})</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ë“±ë¡ì¼</label>
                        <div class="text-base text-gray-900">${new Date(app.created_at).toLocaleDateString()}</div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ìƒíƒœ</label>
                        <div>
                            <span class="${getStatusClass(app.status)}">${getStatusText(app.status)}</span>
                        </div>
                    </div>
                    ${app.confluence_page_url ? `
                    <div>
                        <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">ì›ë³¸ ë¬¸ì„œ</label>
                        <div>
                            <a href="${app.confluence_page_url}" target="_blank" rel="noopener noreferrer"
                               class="inline-flex items-center text-blue-600 hover:text-blue-800 font-medium text-sm">
                                <i class="fa-brands fa-confluence mr-2"></i>
                                Confluenceì—ì„œ ë³´ê¸°
                                <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs"></i>
                            </a>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- AI ìš”ì•½ ê²°ê³¼ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-blue-900 flex items-center">
                        <i class="fa-solid fa-robot text-blue-600 mr-2"></i> AI ë¶„ì„ ë¦¬í¬íŠ¸
                    </h3>
                    <span id="ai-grade-badge"></span>
                </div>
                <div class="p-6" id="ai-report-content">
                    <div class="flex justify-center py-4">
                        <i class="fa-solid fa-circle-notch fa-spin text-gray-400"></i>
                    </div>
                </div>
            </div>
            
            <!-- ê³¼ì œ ìƒì„¸ ë‚´ìš© -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fa-solid fa-align-left text-blue-500 mr-2"></i> ê³¼ì œ ìƒì„¸ ë‚´ìš©
                    </h3>
                </div>
                <div class="divide-y divide-gray-100">
                    <div class="p-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">í˜„ì¬ ì—…ë¬´ (AS-IS)</label>
                        <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">${renderTextWithImages(app.current_work || '-')}</div>
                    </div>
                    <div class="p-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Pain Point (ë¬¸ì œì )</label>
                        <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">${renderTextWithImages(app.pain_point || '-')}</div>
                    </div>
                    <div class="p-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ê°œì„  ì•„ì´ë””ì–´ (TO-BE)</label>
                        <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">${renderTextWithImages(app.improvement_idea || '-')}</div>
                    </div>
                    <div class="p-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ê¸°ëŒ€ íš¨ê³¼</label>
                        <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">${renderTextWithImages(app.expected_effect || '-')}</div>
                    </div>
                    <div class="p-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ê¸°íƒ€ / ë°”ë¼ëŠ” ì </label>
                        <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed whitespace-pre-wrap text-sm">${app.hope || '-'}</div>
                    </div>
                </div>
            </div>
            
            <!-- ê¸°ìˆ  ì—­ëŸ‰ -->
            ${Array.isArray(techCapabilities) && techCapabilities.length > 0 ? `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fa-solid fa-code text-blue-500 mr-2"></i> ê¸°ìˆ  ì—­ëŸ‰
                    </h3>
                </div>
                <div class="p-6">
                    ${(() => {
                        // ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê·¸ë£¹í™”
                        const grouped = {};
                        techCapabilities.forEach(item => {
                            const category = item.category || 'ê¸°íƒ€';
                            if (!grouped[category]) {
                                grouped[category] = [];
                            }
                            grouped[category].push(item);
                        });

                        // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë Œë”ë§
                        return Object.entries(grouped).map(([category, items]) => `
                            <div class="mb-6 last:mb-0">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 pb-2 border-b border-gray-200">
                                    <i class="fa-solid fa-folder text-blue-500 mr-2"></i>${category}
                                </h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${items.map(item => {
                                        const levelText = ['', 'ê¸°ì´ˆ', 'í™œìš©ê°€ëŠ¥', 'ìˆ™ë ¨'][item.level] || item.level;
                                        const levelColor = item.level === 3 ? 'bg-green-100 text-green-800' :
                                                          item.level === 2 ? 'bg-blue-100 text-blue-800' :
                                                          'bg-gray-100 text-gray-800';
                                        return `
                                            <div class="bg-gray-50 rounded-lg p-3 border border-gray-100 hover:shadow-sm transition-shadow">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="text-xs font-medium text-gray-500">${item.field || 'ê¸°íƒ€'}</span>
                                                    <span class="text-xs px-2 py-0.5 rounded-full ${levelColor}">Lv.${item.level}</span>
                                                </div>
                                                <div class="text-sm font-semibold text-gray-900">${item.skill}</div>
                                                <div class="text-xs text-gray-500 mt-1">${levelText}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('');
                    })()}
                </div>
            </div>
            ` : ''}
            
            <!-- ì‚¬ìš©ì í‰ê°€ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                        <i class="fa-solid fa-gavel text-blue-500 mr-2"></i> ì‹¬ì‚¬ìœ„ì› í‰ê°€
                    </h3>
                    ${(user.role === 'admin' || (app.department_id && user.department_id === app.department_id)) ? `
                        <button onclick="showEvaluationForm()" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            <i class="fa-solid fa-pen mr-1.5"></i> ${currentUserEvaluation ? 'ë‚´ í‰ê°€ ìˆ˜ì •' : 'í‰ê°€í•˜ê¸°'}
                        </button>
                    ` : ''}
                </div>
                <div class="p-6">
                    <div id="evaluations-list" class="space-y-4">
                        <div class="flex justify-center py-4">
                            <i class="fa-solid fa-circle-notch fa-spin text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- í‰ê°€ í¼ (ìˆ¨ê¹€) -->
            <div id="evaluation-form" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="hideEvaluationForm()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <div class="sm:flex sm:items-start">
                                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                                    <i class="fa-solid fa-pen text-blue-600"></i>
                                </div>
                                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="evaluation-form-title">í‰ê°€ ì‘ì„±</h3>
                                    <div class="mt-4">
                                        <form onsubmit="submitEvaluation(event)" id="eval-form">
                                            <div class="mb-4">
                                                <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">ë“±ê¸‰ *</label>
                                                <select id="grade" name="grade" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border" required>
                                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                                    <option value="S">S - ìµœìš°ìˆ˜ (íƒì›”í•¨)</option>
                                                    <option value="A">A - ìš°ìˆ˜ (ë§¤ìš° ì¢‹ìŒ)</option>
                                                    <option value="B">B - ì–‘í˜¸ (ì¢‹ìŒ)</option>
                                                    <option value="C">C - ë³´í†µ (í‰ë²”í•¨)</option>
                                                    <option value="D">D - ë¯¸í¡ (ë¶€ì¡±í•¨)</option>
                                                </select>
                                            </div>
                                            <div class="mb-4">
                                                <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">ì‹¬ì‚¬ ì˜ê²¬ *</label>
                                                <textarea id="comment" name="comment" rows="5" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md p-2" placeholder="êµ¬ì²´ì ì¸ ì‹¬ì‚¬ ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." required></textarea>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="button" onclick="document.getElementById('eval-form').dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}))" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                                ì œì¶œí•˜ê¸°
                            </button>
                            <button type="button" onclick="hideEvaluationForm()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // HTML ë Œë”ë§ í›„ í‰ê°€ ëª©ë¡ ë¡œë“œ
        await loadEvaluations();
        
    } catch (error) {
        console.error('Error loading application:', error);
        container.innerHTML = `
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-md">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-circle-exclamation text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">ì§€ì›ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        `;
    }
}

// í—¬í¼ í•¨ìˆ˜ë“¤
function renderTextWithImages(text) {
    if (!text) return text;

    // Markdown ì´ë¯¸ì§€ íŒ¨í„´: ![alt](url)
    const imagePattern = /!\[(.*?)\]\((.*?)\)/g;

    const result = text.replace(imagePattern, (match, alt, url) => {
        // HTML ì´ìŠ¤ì¼€ì´í”„
        const safeAlt = alt.replace(/"/g, '&quot;');
        const safeUrl = url.replace(/"/g, '&quot;');

        // ë¡œì»¬ì— ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ í‘œì‹œ
        return `<img src="${safeUrl}" alt="${safeAlt}" class="max-w-full h-auto my-4 rounded-lg shadow-sm border border-gray-200" style="max-height: 500px; object-fit: contain;" />`;
    });

    return result;
}

function getGradeBadgeClass(grade, isLarge = false) {
    const baseClasses = isLarge 
        ? "inline-flex items-center px-3 py-1 rounded-full text-sm font-bold shadow-sm" 
        : "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium";
    
    if (grade === 'S' || grade >= 90) return `${baseClasses} bg-purple-100 text-purple-800`;
    if (grade === 'A' || grade >= 80) return `${baseClasses} bg-green-100 text-green-800`;
    if (grade === 'B' || grade >= 70) return `${baseClasses} bg-blue-100 text-blue-800`;
    if (grade === 'C' || grade >= 60) return `${baseClasses} bg-yellow-100 text-yellow-800`;
    return `${baseClasses} bg-gray-100 text-gray-800`;
}

function getStatusClass(status) {
    const baseClasses = "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium";
    if (status === 'user_evaluated') return `${baseClasses} bg-blue-100 text-blue-800`;
    if (status === 'ai_evaluated') return `${baseClasses} bg-green-100 text-green-800`;
    return `${baseClasses} bg-gray-100 text-gray-800`;
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'ëŒ€ê¸°',
        'ai_evaluated': 'AI í‰ê°€ ì™„ë£Œ',
        'user_evaluated': 'ì‹¬ì‚¬ ì™„ë£Œ',
        'approved': 'ìŠ¹ì¸',
        'rejected': 'ë°˜ë ¤'
    };
    return statusMap[status] || status;
}

async function loadEvaluations() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}/evaluations`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load evaluations');
        }
        
        allEvaluations = await response.json();
        
        // í˜„ì¬ ì‚¬ìš©ìì˜ í‰ê°€ ì°¾ê¸°
        currentUserEvaluation = allEvaluations.find(e => e.is_current_user);

        renderEvaluations();

        // AI ë¶„ì„ ë¦¬í¬íŠ¸ ë Œë”ë§ (í‰ê°€ ì •ë³´ê°€ ë¡œë“œëœ í›„)
        renderAIReport();
    } catch (error) {
        console.error('Error loading evaluations:', error);
        document.getElementById('evaluations-list').innerHTML =
            '<p class="text-red-500 text-sm p-4">í‰ê°€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// ì‚¬ì—…ë¶€ ëª©ë¡ ë¡œë“œ
async function loadDepartments() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch('/api/departments', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('Failed to load departments');
        }

        allDepartments = await response.json();

        // ì‚¬ì—…ë¶€ ë“œë¡­ë‹¤ìš´ì— ì˜µì…˜ ì¶”ê°€
        const select = document.getElementById('edit-division');
        allDepartments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}

function renderEvaluations() {
    const container = document.getElementById('evaluations-list');
    
    if (allEvaluations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                <p class="text-gray-500 text-sm">ì•„ì§ ë“±ë¡ëœ í‰ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    allEvaluations.forEach((evaluation, index) => {
        const isCurrentUser = evaluation.is_current_user;
        const bgClass = isCurrentUser ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200';
        
        html += `
            <div class="rounded-lg border ${bgClass} p-4 transition-shadow hover:shadow-sm">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="${getGradeBadgeClass(evaluation.grade)}">${evaluation.grade}</span>
                        <span class="font-medium text-gray-900">${evaluation.evaluator_name}</span>
                        ${isCurrentUser ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded">ë‚´ í‰ê°€</span>' : ''}
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">${new Date(evaluation.created_at).toLocaleString('ko-KR')}</span>
                        ${isCurrentUser ? `
                            <button onclick="editMyEvaluation()" class="text-blue-600 hover:text-blue-700 text-sm">
                                <i class="fa-solid fa-pen-to-square"></i> ìˆ˜ì •
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed">${evaluation.comment || '-'}</div>
            </div>
        `;
    });
    
    // í‰ê°€ í†µê³„ ì¶”ê°€ (ê´€ë¦¬ìë§Œ)
    if (user.role === 'admin' && allEvaluations.length > 1) {
        const gradeCount = {};
        allEvaluations.forEach(e => {
            gradeCount[e.grade] = (gradeCount[e.grade] || 0) + 1;
        });
        
        html += `
            <div class="mt-6 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">í‰ê°€ ìš”ì•½</h4>
                <div class="flex flex-wrap gap-2">
                    ${Object.entries(gradeCount).sort().map(([grade, count]) => `
                        <span class="${getGradeBadgeClass(grade)}">${grade}: ${count}ëª…</span>
                    `).join('')}
                </div>
                <p class="text-xs text-gray-500 mt-2">ì´ ${allEvaluations.length}ëª…ì´ í‰ê°€í–ˆìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// AI ë¶„ì„ ë¦¬í¬íŠ¸ ë Œë”ë§
function renderAIReport() {
    if (!currentApplication) return;

    const app = currentApplication;
    const badgeContainer = document.getElementById('ai-grade-badge');
    const contentContainer = document.getElementById('ai-report-content');

    // AI í‰ê°€ ìƒì„¸ íŒŒì‹±
    let aiEvaluationDetail = {};
    if (app.ai_evaluation_detail) {
        try {
            aiEvaluationDetail = typeof app.ai_evaluation_detail === 'string'
                ? JSON.parse(app.ai_evaluation_detail)
                : app.ai_evaluation_detail;
        } catch (e) {
            console.error('AI evaluation detail parsing error:', e);
        }
    }

    // AI ë“±ê¸‰ ë°°ì§€ ë Œë”ë§
    if (app.ai_grade && (user.role === 'admin' || currentUserEvaluation)) {
        badgeContainer.innerHTML = `<span class="${getGradeBadgeClass(app.ai_grade, true)} text-sm px-3 py-1">AI ë“±ê¸‰: ${app.ai_grade}</span>`;
    } else {
        badgeContainer.innerHTML = '';
    }

    // AI ë¶„ì„ ë¦¬í¬íŠ¸ ì»¨í…ì¸  ë Œë”ë§
    if (app.ai_grade && (user.role === 'admin' || currentUserEvaluation)) {
        contentContainer.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-md">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-circle-info text-blue-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            ì´ ë¦¬í¬íŠ¸ëŠ” AIê°€ ì§€ì›ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ìƒì„±í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <div class="space-y-8">
                <!-- 1. AI ê¸°ìˆ  ë¶„ë¥˜ -->
                <div>
                    <h4 class="text-md font-bold text-gray-800 mb-3 flex items-center">
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded mr-2">1</span>
                        AI ê¸°ìˆ  ë¶„ë¥˜
                    </h4>
                    <div class="pl-2">
                        <span class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-semibold bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-sm">
                            <i class="fa-solid fa-layer-group mr-2"></i>
                            ${aiEvaluationDetail.ai_category || app.ai_category_primary || 'ë¯¸ë¶„ë¥˜'}
                        </span>
                    </div>
                </div>

                <!-- 2. ì¡°ì§ ê´€ì ì˜ ê²½ì˜íš¨ê³¼ -->
                <div>
                    <h4 class="text-md font-bold text-gray-800 mb-3 flex items-center">
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded mr-2">2</span>
                        ì¡°ì§ ê´€ì ì˜ ê²½ì˜íš¨ê³¼
                    </h4>
                    <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed border border-gray-100">
                        ${aiEvaluationDetail.business_impact || 'ì •ë³´ ì—†ìŒ'}
                    </div>
                </div>

                <!-- 3. AI ê´€ì ì˜ êµ¬í˜„ ê°€ëŠ¥ì„± -->
                <div>
                    <h4 class="text-md font-bold text-gray-800 mb-3 flex items-center">
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded mr-2">3</span>
                        AI ê´€ì ì˜ êµ¬í˜„ ê°€ëŠ¥ì„±
                    </h4>
                    <div class="bg-gray-50 rounded-lg p-4 text-gray-700 leading-relaxed border border-gray-100">
                        ${aiEvaluationDetail.technical_feasibility || 'ì •ë³´ ì—†ìŒ'}
                    </div>
                </div>

                ${aiEvaluationDetail.debate_summary ? `
                <!-- 3.5. AI ê°„ ë…¼ì˜ ìš”ì•½ (3-Step Debate Mode) -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-4">
                    <h4 class="text-md font-bold text-purple-800 mb-3 flex items-center">
                        <i class="fa-solid fa-comments text-purple-600 mr-2"></i>
                        AI í‰ê°€ì ê°„ ë…¼ì˜ ê²°ê³¼ (3ë‹¨ê³„ í˜‘ì˜)
                    </h4>
                    <div class="text-gray-700 leading-relaxed whitespace-pre-wrap">
                        ${aiEvaluationDetail.debate_summary}
                    </div>
                    <div class="mt-3 bg-white bg-opacity-70 rounded p-3 text-xs">
                        <div class="flex items-center text-purple-700 font-semibold mb-2">
                            <i class="fa-solid fa-diagram-project mr-2"></i>
                            í‰ê°€ í”„ë¡œì„¸ìŠ¤
                        </div>
                        <div class="flex items-center text-gray-600 space-x-2">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">Step 1: LLM A ì´ˆê¸° í‰ê°€</span>
                            <i class="fa-solid fa-arrow-right text-gray-400"></i>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">Step 2: LLM B ê²€í† </span>
                            <i class="fa-solid fa-arrow-right text-gray-400"></i>
                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">Step 3: LLM A ìµœì¢… ê²°ì •</span>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- 4. ì „ì²´ ì§€ì›ì„œ 5ì¤„ ìš”ì•½ -->
                <div>
                    <h4 class="text-md font-bold text-gray-800 mb-3 flex items-center">
                        <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded mr-2">4</span>
                        í•µì‹¬ ìš”ì•½ (5ì¤„)
                    </h4>
                    <ul class="space-y-2">
                        ${aiEvaluationDetail.five_line_summary && aiEvaluationDetail.five_line_summary.length > 0 ?
                            aiEvaluationDetail.five_line_summary.map(line => `
                                <li class="flex items-start bg-white p-3 rounded-lg border border-gray-200 shadow-sm">
                                    <i class="fa-solid fa-check text-green-500 mt-1 mr-3 flex-shrink-0"></i>
                                    <span class="text-gray-700">${line}</span>
                                </li>
                            `).join('') :
                            '<li class="text-gray-500 italic">ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>'}
                    </ul>
                </div>

                ${aiEvaluationDetail.evaluation_scores ? `
                <!-- 5. í‰ê°€ ê¸°ì¤€ë³„ ìƒì„¸ ì ìˆ˜ (ë™ì  ë Œë”ë§) -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h4 class="text-md font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-0.5 rounded mr-2">5</span>
                        AI ë“±ê¸‰ ì‚°ì • ê·¼ê±° (í‰ê· : ${(() => {
                            const scores = Object.values(aiEvaluationDetail.evaluation_scores).map(s => s.score);
                            if (scores.length === 0) return '0.0';
                            const avg = (scores.reduce((a,b) => a+b, 0) / scores.length).toFixed(1);
                            return avg;
                        })()}/5.0 â†’ ${app.ai_grade})
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${(() => {
                            console.log('ğŸ” Rendering evaluation_scores:', aiEvaluationDetail.evaluation_scores);

                            // í‚¤ë³„ ë©”íƒ€ë°ì´í„° ë§¤í•‘ (fallbackìš©)
                            const metaMap = {
                                innovation: { icon: 'lightbulb', label: 'í˜ì‹ ì„±', color: 'yellow' },
                                feasibility: { icon: 'wrench', label: 'ì‹¤í˜„ê°€ëŠ¥ì„±', color: 'green' },
                                impact: { icon: 'chart-line', label: 'íš¨ê³¼ì„±', color: 'blue' },
                                clarity: { icon: 'crosshairs', label: 'ëª…í™•ì„±', color: 'purple' }
                            };

                            // DBì— ì €ì¥ëœ ëª¨ë“  í‰ê°€ ì ìˆ˜ë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§
                            return Object.entries(aiEvaluationDetail.evaluation_scores).map(([key, data]) => {
                                console.log(`  ğŸ“Š Criterion: ${key}`, data);
                                if (!data || typeof data !== 'object') return '';

                                const score = data.score || 0;
                                const rationale = data.rationale || 'í‰ê°€ ê·¼ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                                const percentage = (score / 5) * 100;

                                // ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
                                const meta = metaMap[key] || {
                                    icon: 'star',
                                    label: key.charAt(0).toUpperCase() + key.slice(1),
                                    color: 'gray'
                                };

                                // 3ë‹¨ê³„ debate ì ìˆ˜ í‘œì‹œ
                                let scoreDisplay;
                                if (data.score_a_initial && data.score_b_review && data.score_a_final) {
                                    // 3-step debate mode
                                    scoreDisplay = `${score}/5 <span class="text-xs text-gray-500">(Aâ‚:${data.score_a_initial} â†’ B:${data.score_b_review} â†’ Aâ‚‚:${data.score_a_final})</span>`;
                                } else if (data.score_a && data.score_b) {
                                    // 2-step mode (backward compatibility)
                                    scoreDisplay = `${score}/5 <span class="text-xs text-gray-500">(A:${data.score_a}, B:${data.score_b})</span>`;
                                } else {
                                    // Single LLM mode
                                    scoreDisplay = `${score}/5`;
                                }

                                // Tailwind CSS ì™„ì „ í•˜ë“œì½”ë”© (purge ë°©ì§€)
                                let iconClass, scoreClass, barClass;

                                if (meta.color === 'yellow') {
                                    iconClass = 'text-yellow-500';
                                    scoreClass = 'text-yellow-600';
                                    barClass = 'bg-yellow-500';
                                } else if (meta.color === 'green') {
                                    iconClass = 'text-green-500';
                                    scoreClass = 'text-green-600';
                                    barClass = 'bg-green-500';
                                } else if (meta.color === 'blue') {
                                    iconClass = 'text-blue-500';
                                    scoreClass = 'text-blue-600';
                                    barClass = 'bg-blue-500';
                                } else if (meta.color === 'purple') {
                                    iconClass = 'text-purple-500';
                                    scoreClass = 'text-purple-600';
                                    barClass = 'bg-purple-500';
                                } else {
                                    iconClass = 'text-gray-500';
                                    scoreClass = 'text-gray-600';
                                    barClass = 'bg-gray-500';
                                }

                                return `
                                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center">
                                                <i class="fa-solid fa-${meta.icon} ${iconClass} mr-2"></i>
                                                <h5 class="font-semibold text-gray-800">${meta.label}</h5>
                                            </div>
                                            <span class="text-2xl font-bold ${scoreClass}">${scoreDisplay}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                                            <div class="${barClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                        <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${rationale}</p>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                    <div class="mt-4 bg-gray-50 rounded-lg p-3 text-xs text-gray-600">
                        <strong>ë“±ê¸‰ ê¸°ì¤€:</strong>
                        Së“±ê¸‰(4.5~5.0), Aë“±ê¸‰(3.5~4.4), Bë“±ê¸‰(2.5~3.4), Cë“±ê¸‰(1.5~2.4), Dë“±ê¸‰(1.0~1.4)
                    </div>
                </div>
                ` : Object.keys(aiEvaluationDetail).length > 0 && !aiEvaluationDetail.evaluation_scores ? `
                <!-- êµ¬ë²„ì „ í‰ê°€ ë°ì´í„° í‘œì‹œ -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h4 class="text-md font-bold text-gray-800 mb-4 flex items-center">
                        <span class="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-0.5 rounded mr-2">5</span>
                        AI ë“±ê¸‰ ì‚°ì • ê·¼ê±° (êµ¬ë²„ì „)
                        <span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">ì´ì „ í˜•ì‹</span>
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${Object.entries(aiEvaluationDetail).filter(([key, data]) =>
                            data && typeof data === 'object' && data.score !== undefined
                        ).map(([key, data]) => {
                            const score = data.score || 0;
                            const comment = data.comment || data.rationale || 'í‰ê°€ ê·¼ê±°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                            const percentage = (score / 5) * 100;

                            // ìƒ‰ìƒ í• ë‹¹ (ìˆœí™˜)
                            const colors = ['yellow', 'green', 'blue', 'purple'];
                            const colorIndex = Object.keys(aiEvaluationDetail).indexOf(key) % colors.length;
                            const color = colors[colorIndex];

                            let iconClass, scoreClass, barClass;
                            if (color === 'yellow') {
                                iconClass = 'text-yellow-500';
                                scoreClass = 'text-yellow-600';
                                barClass = 'bg-yellow-500';
                            } else if (color === 'green') {
                                iconClass = 'text-green-500';
                                scoreClass = 'text-green-600';
                                barClass = 'bg-green-500';
                            } else if (color === 'blue') {
                                iconClass = 'text-blue-500';
                                scoreClass = 'text-blue-600';
                                barClass = 'bg-blue-500';
                            } else {
                                iconClass = 'text-purple-500';
                                scoreClass = 'text-purple-600';
                                barClass = 'bg-purple-500';
                            }

                            return `
                                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <i class="fa-solid fa-star ${iconClass} mr-2"></i>
                                            <h5 class="font-semibold text-gray-800">${key}</h5>
                                        </div>
                                        <span class="text-2xl font-bold ${scoreClass}">${score}/5</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                                        <div class="${barClass} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${comment}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex items-start">
                            <i class="fa-solid fa-circle-info text-yellow-600 mt-1 mr-3 flex-shrink-0"></i>
                            <div class="text-sm text-yellow-800">
                                <p class="font-semibold mb-1">ì´ì „ ë²„ì „ì˜ í‰ê°€ ê²°ê³¼ì…ë‹ˆë‹¤</p>
                                <p class="text-sm text-yellow-700">ìƒì„¸í•œ í‰ê°€ ê·¼ê±°ë¥¼ í™•ì¸í•˜ë ¤ë©´ AI ì¬í‰ê°€ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
                            </div>
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                <p class="text-xs text-gray-500">
                    <i class="fa-solid fa-robot mr-1"></i> AI ë¶„ì„ì€ ì§€ì†ì ìœ¼ë¡œ ê°œì„ ë˜ê³  ìˆìŠµë‹ˆë‹¤. ê²°ê³¼ì— ëŒ€í•œ í”¼ë“œë°±ì€ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.
                </p>
            </div>
        `;
    } else if (app.ai_grade && user.role === 'reviewer' && !currentUserEvaluation) {
        contentContainer.innerHTML = `
            <div class="text-center py-10">
                <i class="fa-solid fa-lock text-yellow-300 text-4xl mb-3"></i>
                <p class="text-gray-700 font-medium mb-2">ë³¸ì¸ í‰ê°€ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”</p>
                <p class="text-gray-500 text-sm">ê³µì •í•œ ì‹¬ì‚¬ë¥¼ ìœ„í•´ ë³¸ì¸ í‰ê°€ ì™„ë£Œ í›„ AI ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    } else {
        contentContainer.innerHTML = `
            <div class="text-center py-10">
                <i class="fa-solid fa-hourglass-half text-gray-300 text-4xl mb-3"></i>
                <p class="text-gray-500">ì•„ì§ AI í‰ê°€ê°€ ì§„í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
            </div>
        `;
    }
}

function showEvaluationForm() {
    const form = document.getElementById('evaluation-form');
    const title = document.getElementById('evaluation-form-title');
    
    // í˜„ì¬ ì‚¬ìš©ìì˜ í‰ê°€ê°€ ìˆìœ¼ë©´ í¼ì— ì±„ìš°ê¸°
    if (currentUserEvaluation) {
        title.textContent = 'ë‚´ í‰ê°€ ìˆ˜ì •';
        document.getElementById('grade').value = currentUserEvaluation.grade;
        document.getElementById('comment').value = currentUserEvaluation.comment || '';
    } else {
        title.textContent = 'í‰ê°€ ì‘ì„±';
        document.getElementById('grade').value = '';
        document.getElementById('comment').value = '';
    }
    
    form.classList.remove('hidden');
}

function hideEvaluationForm() {
    document.getElementById('evaluation-form').classList.add('hidden');
}

async function submitEvaluation(event) {
    event.preventDefault();
    
    const grade = document.getElementById('grade').value;
    const comment = document.getElementById('comment').value;
    
    if (!grade || !comment) {
        alert('ë“±ê¸‰ê³¼ ì½”ë©˜íŠ¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}/evaluate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ grade, comment })
        });
        
        if (response.ok) {
            const isUpdate = currentUserEvaluation !== null;
            // ëª¨ë‹¬ ë‹«ê³  ë¦¬ë¡œë“œ
            hideEvaluationForm();
            await loadEvaluations(); // í‰ê°€ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            
            // ì„±ê³µ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (ê°„ë‹¨í•˜ê²Œ êµ¬í˜„)
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
            alertDiv.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> ${isUpdate ? 'í‰ê°€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í‰ê°€ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.'}`;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
            
        } else {
            const error = await response.json();
            alert(`í‰ê°€ ${currentUserEvaluation ? 'ìˆ˜ì •' : 'ì œì¶œ'} ì‹¤íŒ¨: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error submitting evaluation:', error);
        alert('í‰ê°€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ
function showEditModal() {
    if (!currentApplication) {
        alert('ì§€ì›ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }

    // í˜„ì¬ ê°’ìœ¼ë¡œ í¼ ì±„ìš°ê¸°
    document.getElementById('edit-subject').value = currentApplication.subject || '';

    // ì‚¬ì—…ë¶€ ì„ íƒ (department_idê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©, ì—†ìœ¼ë©´ division ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­)
    const selectElement = document.getElementById('edit-division');
    if (currentApplication.department_id) {
        selectElement.value = currentApplication.department_id;
    } else if (currentApplication.division) {
        // division ì´ë¦„ìœ¼ë¡œ ë§¤ì¹­
        const matchingDept = allDepartments.find(d => d.name === currentApplication.division);
        selectElement.value = matchingDept ? matchingDept.id : '';
    } else {
        selectElement.value = '';
    }

    document.getElementById('edit-participant-count').value = currentApplication.participant_count || '';
    document.getElementById('edit-representative-name').value = currentApplication.representative_name || '';
    document.getElementById('edit-representative-knox-id').value = currentApplication.representative_knox_id || '';

    // ëª¨ë‹¬ í‘œì‹œ
    document.getElementById('edit-modal').classList.remove('hidden');
}

// ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
}

// ìˆ˜ì • ì €ì¥
async function handleUpdate(event) {
    event.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> ì €ì¥ ì¤‘...';
    
    try {
        const token = localStorage.getItem('access_token');
        const departmentId = document.getElementById('edit-division').value;
        const updateData = {
            subject: document.getElementById('edit-subject').value,
            department_id: departmentId ? parseInt(departmentId) : null,
            participant_count: parseInt(document.getElementById('edit-participant-count').value) || null,
            representative_name: document.getElementById('edit-representative-name').value || null,
            representative_knox_id: document.getElementById('edit-representative-knox-id').value || null
        };
        
        const response = await fetch(`/api/applications/${applicationId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updateData)
        });
        
        if (response.ok) {
            alert('âœ… ì§€ì›ì„œ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeEditModal();
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            await loadApplicationDetail();
        } else {
            const error = await response.json();
            alert(`âŒ ìˆ˜ì • ì‹¤íŒ¨: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error updating application:', error);
        alert('âŒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// AI ì¬í‰ê°€ ì‹¤í–‰
async function runAIEvaluation() {
    if (!currentApplication) {
        alert('ì§€ì›ì„œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!confirm('ì´ ì§€ì›ì„œì— ëŒ€í•´ AI ì¬í‰ê°€ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ê¸°ì¡´ AI í‰ê°€ ê²°ê³¼ê°€ ìƒˆë¡œìš´ ê²°ê³¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.\nâš ï¸ LLM API ë¹„ìš©ì´ ë°œìƒí•©ë‹ˆë‹¤.')) {
        return;
    }
    
    // ë²„íŠ¼ ì°¾ê¸° ë° ë¹„í™œì„±í™”
    const buttons = document.querySelectorAll('button');
    let aiEvalBtn = null;
    buttons.forEach(btn => {
        if (btn.textContent.includes('AI ì¬í‰ê°€')) {
            aiEvalBtn = btn;
        }
    });
    
    if (aiEvalBtn) {
        const originalText = aiEvalBtn.innerHTML;
        aiEvalBtn.disabled = true;
        aiEvalBtn.innerHTML = '<i class="fa-solid fa-robot fa-bounce mr-2"></i> AI í‰ê°€ ì¤‘...';
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/evaluations/${applicationId}/re-evaluate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                alert('âœ… AI ì¬í‰ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì–´ ìƒˆë¡œìš´ í‰ê°€ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                await loadApplicationDetail();
            } else {
                const error = await response.json();
                alert(`âŒ AI ì¬í‰ê°€ ì‹¤íŒ¨: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error running AI evaluation:', error);
            alert('âŒ AI ì¬í‰ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ë‚˜ LLM API ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } finally {
            if (aiEvalBtn) {
                aiEvalBtn.disabled = false;
                aiEvalBtn.innerHTML = originalText;
            }
        }
    }
}

// ë‚´ í‰ê°€ ìˆ˜ì •
function editMyEvaluation() {
    showEvaluationForm();
}

// ì‚­ì œ
async function deleteApplication() {
    if (!confirm('ì •ë§ ì´ ì§€ì›ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            alert('ì§€ì›ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/applications';
        } else {
            const error = await response.json();
            alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting application:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

const user = {
    id: {{ user.id }},
    username: "{{ user.username }}",
    name: "{{ user.name }}",
    role: "{{ user.role }}",
    department_id: {{ user.department_id if user.department_id else 'null' }}
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
loadDepartments();
loadApplicationDetail();
</script>
{% endblock %}
