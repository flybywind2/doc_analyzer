{% extends "base.html" %}

{% block title %}지원서 상세{% endblock %}

{% block content %}
<div class="page-header">
    <h2>지원서 상세</h2>
    <div class="actions">
        <button onclick="history.back()" class="btn btn-secondary">목록으로</button>
        {% if user.role == 'admin' %}
        <button onclick="deleteApplication()" class="btn btn-danger">삭제</button>
        {% endif %}
    </div>
</div>

<div id="application-detail" class="detail-container">
    <!-- 로딩 중 -->
    <div class="loading">데이터를 불러오는 중...</div>
</div>

<script>
const applicationId = {{ application_id }};
let currentApplication = null;
let allEvaluations = [];
let currentUserEvaluation = null;

// 애플리케이션 데이터 로드
async function loadApplicationDetail() {
    const container = document.getElementById('application-detail');
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load application');
        }
        
        const app = await response.json();
        currentApplication = app; // 전역 변수에 저장
        
        // AI 카테고리 파싱
        let aiCategories = [];
        if (app.ai_categories) {
            try {
                aiCategories = typeof app.ai_categories === 'string' 
                    ? JSON.parse(app.ai_categories) 
                    : app.ai_categories;
            } catch (e) {
                console.error('AI categories parsing error:', e);
            }
        }
        
        // AI 평가 상세 파싱
        let aiEvaluationDetail = {};
        if (app.ai_evaluation_detail) {
            try {
                aiEvaluationDetail = typeof app.ai_evaluation_detail === 'string'
                    ? JSON.parse(app.ai_evaluation_detail)
                    : app.ai_evaluation_detail;
            } catch (e) {
                console.error('AI evaluation detail parsing error:', e);
            }
        }
        
        // 기술 역량 파싱
        let techCapabilities = {};
        if (app.tech_capabilities) {
            try {
                techCapabilities = typeof app.tech_capabilities === 'string'
                    ? JSON.parse(app.tech_capabilities)
                    : app.tech_capabilities;
            } catch (e) {
                console.error('Tech capabilities parsing error:', e);
            }
        }
        
        container.innerHTML = `
            <!-- 기본 정보 -->
            <div class="card">
                <h3>기본 정보</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>과제명</label>
                        <div>${app.subject || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>사업부</label>
                        <div>${app.division || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>부서</label>
                        <div>${app.department_name || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <label>참여 인원</label>
                        <div>${app.participant_count || '-'}명</div>
                    </div>
                    <div class="detail-item">
                        <label>대표자</label>
                        <div>${app.representative_name || '-'} (${app.representative_knox_id || '-'})</div>
                    </div>
                    <div class="detail-item">
                        <label>상태</label>
                        <div><span class="badge badge-${app.status}">${getStatusText(app.status)}</span></div>
                    </div>
                </div>
            </div>
            
            <!-- AI 평가 결과 -->
            <div class="card">
                <h3>AI 평가 결과</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>AI 등급</label>
                        <div><span class="badge badge-grade-${app.ai_grade || 'none'}">${app.ai_grade || '미평가'}</span></div>
                    </div>
                    <div class="detail-item">
                        <label>AI 기술 분류</label>
                        <div>
                            ${aiCategories.length > 0 
                                ? aiCategories.map(cat => `<span class="badge">${cat.category} (${Math.round(cat.confidence * 100)}%)</span>`).join(' ')
                                : '<span class="text-muted">분류되지 않음</span>'}
                        </div>
                    </div>
                    <div class="detail-item full-width">
                        <label>AI 요약</label>
                        <div>${app.ai_summary || '평가되지 않음'}</div>
                    </div>
                </div>
                
                ${aiEvaluationDetail.scores ? `
                <div class="evaluation-scores">
                    <h4>세부 평가 점수</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>평가 항목</th>
                                <th>점수</th>
                                <th>등급</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(aiEvaluationDetail.scores).map(([name, data]) => `
                                <tr>
                                    <td>${name}</td>
                                    <td>${data.score}/5</td>
                                    <td><span class="badge badge-grade-${data.grade}">${data.grade}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ` : ''}
            </div>
            
            <!-- 과제 내용 -->
            <div class="card">
                <h3>과제 내용</h3>
                <div class="detail-item">
                    <label>현재 업무</label>
                    <div class="text-content">${app.current_work || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>Pain Point</label>
                    <div class="text-content">${app.pain_point || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>개선 아이디어</label>
                    <div class="text-content">${app.improvement_idea || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>기대 효과</label>
                    <div class="text-content">${app.expected_effect || '-'}</div>
                </div>
                <div class="detail-item">
                    <label>바라는 점</label>
                    <div class="text-content">${app.hope || '-'}</div>
                </div>
            </div>
            
            <!-- 기술 역량 -->
            ${Object.keys(techCapabilities).length > 0 ? `
            <div class="card">
                <h3>기술 역량</h3>
                <div class="tech-capabilities">
                    ${Object.entries(techCapabilities).map(([key, value]) => `
                        <div class="tech-item">
                            <label>${key}</label>
                            <div>${value}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- 사용자 평가 -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">심사위원 평가</h3>
                    ${(user.role === 'admin' || (app.department_id && user.department_id === app.department_id)) ? `
                        <button onclick="showEvaluationForm()" class="btn btn-primary">
                            ${currentUserEvaluation ? '내 평가 수정' : '평가하기'}
                        </button>
                    ` : ''}
                </div>
                <div id="evaluations-list">
                    <p class="text-muted">평가를 불러오는 중...</p>
                </div>
            </div>
            
            <!-- 평가 폼 (숨김) -->
            <div id="evaluation-form" class="card" style="display: none;">
                <h3 id="evaluation-form-title">평가 작성</h3>
                <form onsubmit="submitEvaluation(event)">
                    <div class="form-group">
                        <label for="grade">등급 *</label>
                        <select id="grade" name="grade" class="form-control" required>
                            <option value="">선택하세요</option>
                            <option value="S">S - 최우수</option>
                            <option value="A">A - 우수</option>
                            <option value="B">B - 양호</option>
                            <option value="C">C - 보통</option>
                            <option value="D">D - 미흡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="comment">코멘트 *</label>
                        <textarea id="comment" name="comment" class="form-control" rows="5" required></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">평가 제출</button>
                        <button type="button" onclick="hideEvaluationForm()" class="btn btn-secondary">취소</button>
                    </div>
                </form>
            </div>
        `;
        
        // HTML 렌더링 후 평가 목록 로드
        await loadEvaluations();
        
    } catch (error) {
        console.error('Error loading application:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                지원서를 불러오는 중 오류가 발생했습니다.
            </div>
        `;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': '대기',
        'ai_evaluated': 'AI 평가 완료',
        'user_evaluated': '심사 완료',
        'approved': '승인',
        'rejected': '반려'
    };
    return statusMap[status] || status;
}

async function loadEvaluations() {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}/evaluations`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to load evaluations');
        }
        
        allEvaluations = await response.json();
        
        // 현재 사용자의 평가 찾기
        currentUserEvaluation = allEvaluations.find(e => e.is_current_user);
        
        renderEvaluations();
    } catch (error) {
        console.error('Error loading evaluations:', error);
        document.getElementById('evaluations-list').innerHTML = 
            '<p class="text-danger">평가 목록을 불러오는데 실패했습니다.</p>';
    }
}

function renderEvaluations() {
    const container = document.getElementById('evaluations-list');
    
    if (allEvaluations.length === 0) {
        container.innerHTML = '<p class="text-muted">아직 평가가 없습니다.</p>';
        return;
    }
    
    let html = '<div class="evaluations-grid">';
    
    allEvaluations.forEach((evaluation, index) => {
        const isCurrentUser = evaluation.is_current_user;
        html += `
            <div class="evaluation-card ${isCurrentUser ? 'current-user-evaluation' : ''}">
                <div class="evaluation-header">
                    <div>
                        <span class="badge badge-grade-${evaluation.grade}">${evaluation.grade}</span>
                        <strong style="margin-left: 0.5rem;">${evaluation.evaluator_name}</strong>
                        ${isCurrentUser ? '<span class="badge badge-info" style="margin-left: 0.5rem;">내 평가</span>' : ''}
                    </div>
                    <small class="text-muted">${new Date(evaluation.created_at).toLocaleString('ko-KR')}</small>
                </div>
                <div class="evaluation-content">
                    <p class="text-content">${evaluation.comment || '-'}</p>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // 평가 통계 추가 (관리자만)
    if (user.role === 'admin' && allEvaluations.length > 1) {
        const gradeCount = {};
        allEvaluations.forEach(e => {
            gradeCount[e.grade] = (gradeCount[e.grade] || 0) + 1;
        });
        
        html += '<div class="evaluation-summary">';
        html += '<h4>평가 요약</h4>';
        html += '<div class="grade-distribution">';
        Object.entries(gradeCount).sort().forEach(([grade, count]) => {
            html += `<span class="badge badge-grade-${grade}" style="margin-right: 0.5rem;">${grade}: ${count}명</span>`;
        });
        html += '</div>';
        html += `<p class="text-muted" style="margin-top: 0.5rem;">총 ${allEvaluations.length}명이 평가했습니다.</p>`;
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function showEvaluationForm() {
    const form = document.getElementById('evaluation-form');
    const title = document.getElementById('evaluation-form-title');
    
    // 현재 사용자의 평가가 있으면 폼에 채우기
    if (currentUserEvaluation) {
        title.textContent = '내 평가 수정';
        document.getElementById('grade').value = currentUserEvaluation.grade;
        document.getElementById('comment').value = currentUserEvaluation.comment || '';
    } else {
        title.textContent = '평가 작성';
        document.getElementById('grade').value = '';
        document.getElementById('comment').value = '';
    }
    
    form.style.display = 'block';
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideEvaluationForm() {
    document.getElementById('evaluation-form').style.display = 'none';
}

async function submitEvaluation(event) {
    event.preventDefault();
    
    const grade = document.getElementById('grade').value;
    const comment = document.getElementById('comment').value;
    
    if (!grade || !comment) {
        alert('등급과 코멘트를 모두 입력해주세요.');
        return;
    }
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}/evaluate`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ grade, comment })
        });
        
        if (response.ok) {
            const isUpdate = currentUserEvaluation !== null;
            alert(isUpdate ? '평가가 수정되었습니다.' : '평가가 제출되었습니다.');
            hideEvaluationForm();
            await loadEvaluations(); // 평가 목록 다시 로드
        } else {
            const error = await response.json();
            alert(`평가 ${currentUserEvaluation ? '수정' : '제출'} 실패: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error submitting evaluation:', error);
        alert('평가 제출 중 오류가 발생했습니다.');
    }
}

async function deleteApplication() {
    if (!confirm('정말 이 지원서를 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/applications/${applicationId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            alert('지원서가 삭제되었습니다.');
            window.location.href = '/applications';
        } else {
            const error = await response.json();
            alert(`삭제 실패: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting application:', error);
        alert('삭제 중 오류가 발생했습니다.');
    }
}

const user = {
    id: {{ user.id }},
    username: "{{ user.username }}",
    name: "{{ user.name }}",
    role: "{{ user.role }}"
};

// 페이지 로드 시 실행
loadApplicationDetail();
</script>

<style>
.detail-container {
    max-width: 1200px;
    margin: 0 auto;
}

.card {
    background: white;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 16px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-item.full-width {
    grid-column: 1 / -1;
}

.detail-item label {
    font-weight: 600;
    color: #666;
    font-size: 14px;
}

.detail-item > div {
    font-size: 16px;
    color: #333;
}

.text-content {
    white-space: pre-wrap;
    line-height: 1.6;
    background: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
}

.tech-capabilities {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.tech-item {
    padding: 12px;
    background: #f5f5f5;
    border-radius: 4px;
}

.tech-item label {
    font-size: 12px;
    color: #666;
    display: block;
    margin-bottom: 4px;
}

.evaluation-scores {
    margin-top: 20px;
}

.evaluation-scores h4 {
    margin-bottom: 12px;
}

.badge-grade-S { background: #10b981; color: white; }
.badge-grade-A { background: #3b82f6; color: white; }
.badge-grade-B { background: #f59e0b; color: white; }
.badge-grade-C { background: #ef4444; color: white; }
.badge-grade-D { background: #6b7280; color: white; }
.badge-grade-none { background: #e5e7eb; color: #6b7280; }

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #374151;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

.text-content {
    white-space: pre-wrap;
    line-height: 1.6;
}

.evaluations-grid {
    display: grid;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.evaluation-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafb;
}

.evaluation-card.current-user-evaluation {
    border-color: #667eea;
    background: #f0f4ff;
}

.evaluation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
}

.evaluation-content p {
    margin: 0;
    color: #374151;
}

.evaluation-summary {
    margin-top: 1.5rem;
    padding: 1rem;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
}

.evaluation-summary h4 {
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
    color: #374151;
}

.grade-distribution {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.badge-info {
    background: #3b82f6;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
}
</style>
{% endblock %}
