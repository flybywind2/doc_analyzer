{% extends "base.html" %}

{% block title %}ì‚¬ì—…ë¶€ ê´€ë¦¬{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ì‚¬ì—…ë¶€ ê´€ë¦¬</h2>
    <div class="actions">
        <button onclick="showCreateForm()" class="btn btn-primary">ì‚¬ì—…ë¶€ ì¶”ê°€</button>
    </div>
</div>

<!-- ì‚¬ì—…ë¶€ ëª©ë¡ -->
<div class="card">
    <table class="table" id="departments-table">
        <thead>
            <tr>
                <th>ì‚¬ì—…ë¶€ëª…</th>
                <th>ì„¤ëª…</th>
                <th>ì§€ì›ì„œ ìˆ˜</th>
                <th>ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>
        </tbody>
    </table>
</div>

<!-- ì‚¬ì—…ë¶€ ìƒì„±/ìˆ˜ì • ëª¨ë‹¬ -->
<div id="dept-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">ì‚¬ì—…ë¶€ ì¶”ê°€</h3>
            <button onclick="closeModal()" class="close-btn">&times;</button>
        </div>
        <form id="dept-form" onsubmit="submitDepartment(event)">
            <input type="hidden" id="dept-id">
            <div class="form-group">
                <label for="name">ì‚¬ì—…ë¶€ëª… *</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="description">ì„¤ëª…</label>
                <textarea id="description" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
                <button type="button" onclick="closeModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- ì§€ì›ì„œ ë¹„êµ ëª¨ë‹¬ -->
<div id="compare-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="compare-modal-title">ì§€ì›ì„œ ë¹„êµ</h2>
            <button class="close-btn" onclick="closeCompareModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="compare-instructions">
                <p>ğŸ“Œ ìµœëŒ€ 5ê°œì˜ ì§€ì›ì„œë¥¼ ì„ íƒí•˜ì—¬ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <!-- ì§€ì›ì„œ ì„ íƒ ì˜ì—­ -->
            <div class="selection-area">
                <h3>ì§€ì›ì„œ ì„ íƒ <span id="selection-count">(0/5)</span></h3>
                <div id="applications-list" class="applications-grid">
                    <div class="text-center p-4">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <!-- ë¹„êµ ë²„íŠ¼ -->
            <div class="compare-actions">
                <button class="btn btn-secondary" onclick="closeCompareModal()">ì·¨ì†Œ</button>
                <button id="compare-btn" class="btn btn-primary" onclick="showComparison()" disabled>
                    ì„ íƒí•œ ì§€ì›ì„œ ë¹„êµí•˜ê¸°
                </button>
            </div>
            
            <!-- ë¹„êµ ê²°ê³¼ ì˜ì—­ -->
            <div id="comparison-result" style="display: none;">
                <div class="comparison-header">
                    <h3>ë¹„êµ ê²°ê³¼</h3>
                    <button class="btn btn-sm btn-secondary" onclick="resetComparison()">ë‹¤ì‹œ ì„ íƒ</button>
                </div>
                <div id="comparison-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
let allDepartments = [];
let departmentApplications = {};
let selectedApplications = [];
let currentDepartmentId = null;
let currentDepartmentName = '';

async function loadDepartments() {
    try {
        const token = localStorage.getItem('access_token');
        
        // ì‚¬ì—…ë¶€ ëª©ë¡ ë¡œë“œ
        const deptResponse = await fetch('/api/departments', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!deptResponse.ok) throw new Error('Failed to load departments');
        
        allDepartments = await deptResponse.json();
        
        // ì „ì²´ ì§€ì›ì„œ ë¡œë“œ ë° ì‚¬ì—…ë¶€ë³„ ê·¸ë£¹í™”
        const appsResponse = await fetch('/api/applications', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (appsResponse.ok) {
            const applications = await appsResponse.json();
            
            // ì‚¬ì—…ë¶€ë³„ ê·¸ë£¹í™”
            departmentApplications = {};
            allDepartments.forEach(dept => {
                departmentApplications[dept.id] = applications.filter(app => 
                    app.department_id === dept.id
                );
            });
        }
        
        const tbody = document.querySelector('#departments-table tbody');
        
        if (allDepartments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center">ì‚¬ì—…ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            return;
        }
        
        tbody.innerHTML = allDepartments.map(dept => {
            const appCount = departmentApplications[dept.id]?.length || 0;
            return `
            <tr>
                <td><strong>${dept.name}</strong></td>
                <td>${dept.description || '-'}</td>
                <td>${appCount}ê°œ</td>
                <td>
                    <button onclick="openCompareModal(${dept.id}, '${dept.name}')" class="btn btn-sm btn-primary" ${appCount < 2 ? 'disabled' : ''}>
                        <i class="fas fa-balance-scale"></i> ì§€ì›ì„œ ë¹„êµ
                    </button>
                    <button onclick="editDepartment(${dept.id})" class="btn btn-sm btn-secondary">ìˆ˜ì •</button>
                    <button onclick="deleteDepartment(${dept.id})" class="btn btn-sm btn-danger">ì‚­ì œ</button>
                </td>
            </tr>
        `}).join('');
    } catch (error) {
        console.error('Error loading departments:', error);
        const tbody = document.querySelector('#departments-table tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</td></tr>';
    }
}

function showCreateForm() {
    document.getElementById('modal-title').textContent = 'ì‚¬ì—…ë¶€ ì¶”ê°€';
    document.getElementById('dept-form').reset();
    document.getElementById('dept-id').value = '';
    document.getElementById('dept-modal').style.display = 'flex';
}

async function editDepartment(deptId) {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/departments/${deptId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Failed to load department');
        
        const dept = await response.json();
        
        document.getElementById('modal-title').textContent = 'ì‚¬ì—…ë¶€ ìˆ˜ì •';
        document.getElementById('dept-id').value = dept.id;
        document.getElementById('name').value = dept.name;
        document.getElementById('description').value = dept.description || '';
        document.getElementById('dept-modal').style.display = 'flex';
    } catch (error) {
        console.error('Error loading department:', error);
        alert('ì‚¬ì—…ë¶€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
}

async function submitDepartment(event) {
    event.preventDefault();
    
    const deptId = document.getElementById('dept-id').value;
    const data = {
        name: document.getElementById('name').value,
        description: document.getElementById('description').value || null
    };
    
    try {
        const token = localStorage.getItem('access_token');
        const url = deptId ? `/api/departments/${deptId}` : '/api/departments';
        const method = deptId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method,
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert(deptId ? 'ì‚¬ì—…ë¶€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì‚¬ì—…ë¶€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
            closeModal();
            loadDepartments();
        } else {
            const error = await response.json();
            alert(`ì˜¤ë¥˜: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error submitting department:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

async function deleteDepartment(deptId) {
    if (!confirm('ì •ë§ ì´ ì‚¬ì—…ë¶€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/api/departments/${deptId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            alert('ì‚¬ì—…ë¶€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            loadDepartments();
        } else {
            const error = await response.json();
            alert(`ì‚­ì œ ì‹¤íŒ¨: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error deleting department:', error);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
    }
}

function closeModal() {
    document.getElementById('dept-modal').style.display = 'none';
}

// ë¹„êµ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
function openCompareModal(deptId, deptName) {
    currentDepartmentId = deptId;
    currentDepartmentName = deptName;
    selectedApplications = [];
    document.getElementById('compare-modal-title').textContent = `${deptName} ì§€ì›ì„œ ë¹„êµ`;
    document.getElementById('compare-modal').style.display = 'flex';
    document.getElementById('comparison-result').style.display = 'none';
    renderApplicationsList();
}

function closeCompareModal() {
    document.getElementById('compare-modal').style.display = 'none';
    selectedApplications = [];
    currentDepartmentId = null;
}

function renderApplicationsList() {
    const apps = departmentApplications[currentDepartmentId] || [];
    const container = document.getElementById('applications-list');
    
    if (apps.length === 0) {
        container.innerHTML = '<div class="text-center p-4">ì´ ì‚¬ì—…ë¶€ì— ì§€ì›ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    container.innerHTML = apps.map(app => `
        <div class="application-card ${selectedApplications.includes(app.id) ? 'selected' : ''}" 
             onclick="toggleSelection(${app.id})">
            <div class="app-header">
                <input type="checkbox" ${selectedApplications.includes(app.id) ? 'checked' : ''} 
                       onclick="event.stopPropagation(); toggleSelection(${app.id})">
                <span class="badge badge-grade-${app.ai_grade || 'B'}">${app.ai_grade || 'N/A'}</span>
            </div>
            <h4>${app.subject}</h4>
            <div class="app-info">
                <span><i class="fas fa-tag"></i> ${app.ai_category_primary || 'ë¯¸ë¶„ë¥˜'}</span>
                <span><i class="fas fa-users"></i> ${app.participant_count || 0}ëª…</span>
            </div>
            <div class="app-summary">
                ${app.pain_point ? app.pain_point.substring(0, 100) + '...' : 'Pain Point ì—†ìŒ'}
            </div>
        </div>
    `).join('');
    
    updateSelectionCount();
}

function toggleSelection(appId) {
    const index = selectedApplications.indexOf(appId);
    
    if (index > -1) {
        selectedApplications.splice(index, 1);
    } else {
        if (selectedApplications.length >= 5) {
            alert('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }
        selectedApplications.push(appId);
    }
    
    renderApplicationsList();
}

function updateSelectionCount() {
    document.getElementById('selection-count').textContent = `(${selectedApplications.length}/5)`;
    document.getElementById('compare-btn').disabled = selectedApplications.length < 2;
}

function showComparison() {
    if (selectedApplications.length < 2) {
        alert('ìµœì†Œ 2ê°œì˜ ì§€ì›ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì„ íƒëœ ì§€ì›ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const apps = departmentApplications[currentDepartmentId].filter(app => 
        selectedApplications.includes(app.id)
    );
    
    // ë¹„êµ ê²°ê³¼ í‘œì‹œ
    document.querySelector('.selection-area').style.display = 'none';
    document.querySelector('.compare-actions').style.display = 'none';
    document.getElementById('comparison-result').style.display = 'block';
    
    renderComparison(apps);
}

function renderComparison(apps) {
    const container = document.getElementById('comparison-content');
    
    let html = `
        <div class="comparison-table-wrapper">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th class="sticky-col">ë¹„êµ í•­ëª©</th>
                        ${apps.map((app, idx) => `
                            <th>ì§€ì›ì„œ ${idx + 1}</th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <tr class="section-header">
                        <td class="sticky-col" colspan="${apps.length + 1}">ğŸ“‹ ê¸°ë³¸ ì •ë³´</td>
                    </tr>
                    <tr>
                        <td class="sticky-col">ê³¼ì œëª…</td>
                        ${apps.map(app => `<td><strong>${app.subject}</strong></td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">AI ì¹´í…Œê³ ë¦¬</td>
                        ${apps.map(app => `<td><span class="badge badge-category">${app.ai_category_primary || 'ë¯¸ë¶„ë¥˜'}</span></td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ì°¸ì—¬ ì¸ì›</td>
                        ${apps.map(app => `<td>${app.participant_count || 0}ëª…</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">AI ë“±ê¸‰</td>
                        ${apps.map(app => `<td><span class="badge badge-grade-${app.ai_grade || 'B'}">${app.ai_grade || 'N/A'}</span></td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ëŒ€í‘œì</td>
                        ${apps.map(app => `<td>${app.representative_name || '-'}</td>`).join('')}
                    </tr>
                    
                    <!-- ë¬¸ì œ ë° í•´ê²°ë°©ì•ˆ -->
                    <tr class="section-header">
                        <td class="sticky-col" colspan="${apps.length + 1}">ğŸ¯ ë¬¸ì œ ë° í•´ê²°ë°©ì•ˆ</td>
                    </tr>
                    <tr>
                        <td class="sticky-col">Pain Point</td>
                        ${apps.map(app => `<td class="text-cell">${app.pain_point || '-'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ê°œì„  ì•„ì´ë””ì–´</td>
                        ${apps.map(app => `<td class="text-cell">${app.improvement_idea || '-'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ê¸°ëŒ€ íš¨ê³¼</td>
                        ${apps.map(app => `<td class="text-cell">${app.expected_effect || '-'}</td>`).join('')}
                    </tr>
                    
                    <!-- AI ìš”ì•½ -->
                    <tr class="section-header">
                        <td class="sticky-col" colspan="${apps.length + 1}">ğŸ¤– AI ìš”ì•½</td>
                    </tr>
                    <tr>
                        <td class="sticky-col">ê²½ì˜íš¨ê³¼</td>
                        ${apps.map(app => {
                            const detail = app.ai_evaluation_detail || {};
                            return `<td class="text-cell">${detail.business_impact || '-'}</td>`;
                        }).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">êµ¬í˜„ ê°€ëŠ¥ì„±</td>
                        ${apps.map(app => {
                            const detail = app.ai_evaluation_detail || {};
                            return `<td class="text-cell">${detail.technical_feasibility || '-'}</td>`;
                        }).join('')}
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="comparison-actions-bottom">
            <button class="btn btn-secondary" onclick="resetComparison()">
                <i class="fas fa-redo"></i> ë‹¤ì‹œ ì„ íƒ
            </button>
            <button class="btn btn-primary" onclick="printComparison()">
                <i class="fas fa-print"></i> ì¸ì‡„
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function resetComparison() {
    selectedApplications = [];
    document.querySelector('.selection-area').style.display = 'block';
    document.querySelector('.compare-actions').style.display = 'flex';
    document.getElementById('comparison-result').style.display = 'none';
    renderApplicationsList();
}

function printComparison() {
    window.print();
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
loadDepartments();
</script>

<style>
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 1000;
    overflow-y: auto;
}

.modal-content {
    background: white;
    border-radius: 8px;
    padding: 0;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    margin: 2rem auto;
}

.modal-large {
    max-width: 1200px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3, .modal-header h2 {
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.modal-content form {
    padding: 20px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

/* ì§€ì›ì„œ ë¹„êµ ìŠ¤íƒ€ì¼ */
.compare-instructions {
    background: #f0f9ff;
    padding: 1rem;
    border-left: 4px solid #3b82f6;
    border-radius: 4px;
    margin-bottom: 1.5rem;
}

.compare-instructions p {
    margin: 0;
    color: #1e40af;
}

.selection-area h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

#selection-count {
    color: #667eea;
    font-weight: 700;
}

.applications-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.application-card {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.application-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 6px rgba(102, 126, 234, 0.1);
}

.application-card.selected {
    border-color: #667eea;
    background: #f0f4ff;
}

.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.app-header input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.application-card h4 {
    margin: 0.75rem 0;
    font-size: 1rem;
    color: #1e293b;
    line-height: 1.4;
}

.app-info {
    display: flex;
    gap: 1rem;
    margin: 0.5rem 0;
    font-size: 0.85rem;
    color: #64748b;
}

.app-info i {
    margin-right: 0.25rem;
}

.app-summary {
    font-size: 0.85rem;
    color: #64748b;
    line-height: 1.5;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.compare-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}

.comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.comparison-header h3 {
    margin: 0;
}

.comparison-table-wrapper {
    overflow-x: auto;
    margin-bottom: 1.5rem;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.comparison-table th,
.comparison-table td {
    padding: 1rem;
    text-align: left;
    border: 1px solid #e2e8f0;
}

.comparison-table thead th {
    background: #f8fafc;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

.comparison-table .sticky-col {
    position: sticky;
    left: 0;
    background: #f8fafc;
    font-weight: 600;
    z-index: 5;
    min-width: 150px;
}

.comparison-table .section-header td {
    background: #667eea;
    color: white;
    font-weight: 700;
    font-size: 1rem;
}

.comparison-table .text-cell {
    max-width: 300px;
    white-space: pre-wrap;
    line-height: 1.6;
}

.comparison-actions-bottom {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

.badge-category {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 700;
}

.badge-grade-S { background: #10b981; color: white; padding: 0.35rem 0.75rem; border-radius: 4px; }
.badge-grade-A { background: #3b82f6; color: white; padding: 0.35rem 0.75rem; border-radius: 4px; }
.badge-grade-B { background: #f59e0b; color: white; padding: 0.35rem 0.75rem; border-radius: 4px; }
.badge-grade-C { background: #ef4444; color: white; padding: 0.35rem 0.75rem; border-radius: 4px; }
.badge-grade-D { background: #6b7280; color: white; padding: 0.35rem 0.75rem; border-radius: 4px; }

/* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
@media print {
    .modal-header,
    .comparison-actions-bottom,
    .compare-actions {
        display: none !important;
    }
    
    .modal {
        background: white !important;
    }
    
    .modal-content {
        box-shadow: none !important;
        max-width: 100% !important;
    }
    
    .comparison-table {
        font-size: 0.75rem;
    }
    
    .comparison-table th,
    .comparison-table td {
        padding: 0.5rem;
    }
}
</style>
{% endblock %}
