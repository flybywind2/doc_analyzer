{% extends "base.html" %}

{% block title %}ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ - AI ê³¼ì œ ì§€ì›ì„œ í‰ê°€ ì‹œìŠ¤í…œ{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h1>AI ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h1>
        <button class="btn btn-primary" onclick="showCreateModal()">
            <i class="fas fa-plus"></i> ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="loading" style="display: none;" class="text-center p-4">
                <div class="spinner"></div>
            </div>

            <table class="table" id="categories-table">
                <thead>
                    <tr>
                        <th>AI ì¹´í…Œê³ ë¦¬</th>
                        <th>ì§€ì›ì„œ ìˆ˜</th>
                        <th>ì„¤ëª…</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="categories-tbody">
                    <tr><td colspan="4" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ì§€ì›ì„œ ë¹„êµ ëª¨ë‹¬ -->
<div id="compare-modal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="compare-modal-title">ì§€ì›ì„œ ë¹„êµ</h2>
            <button class="close-btn" onclick="closeCompareModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="compare-instructions">
                <p>ğŸ“Œ ìµœëŒ€ 3ê°œì˜ ì§€ì›ì„œë¥¼ ì„ íƒí•˜ì—¬ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <!-- ì§€ì›ì„œ ì„ íƒ ì˜ì—­ -->
            <div class="selection-area">
                <h3>ì§€ì›ì„œ ì„ íƒ <span id="selection-count">(0/3)</span></h3>
                <div id="applications-list" class="applications-grid">
                    <div class="text-center p-4">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
            
            <!-- ë¹„êµ ë²„íŠ¼ -->
            <div class="compare-actions">
                <button class="btn btn-secondary" onclick="closeCompareModal()">ì·¨ì†Œ</button>
                <button id="compare-btn" class="btn btn-primary" onclick="showComparison()" disabled>
                    ì„ íƒí•œ ì§€ì›ì„œ ë¹„êµí•˜ê¸°
                </button>
            </div>
            
            <!-- ë¹„êµ ê²°ê³¼ ì˜ì—­ -->
            <div id="comparison-result" style="display: none;">
                <div class="comparison-header">
                    <h3>ë¹„êµ ê²°ê³¼</h3>
                    <button class="btn btn-sm btn-secondary" onclick="resetComparison()">ë‹¤ì‹œ ì„ íƒ</button>
                </div>
                <div id="comparison-content"></div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="category-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="category-form" onsubmit="handleSubmit(event)">
                <input type="hidden" id="category-id">
                
                <div class="form-group">
                    <label for="category-name">ì¹´í…Œê³ ë¦¬ëª… *</label>
                    <input type="text" id="category-name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="category-description">ì„¤ëª…</label>
                    <textarea id="category-description" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="category-active" checked>
                        í™œì„±í™”
                    </label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let categories = [];
let aiCategories = ['ì˜ˆì¸¡', 'ë¶„ë¥˜', 'ì±—ë´‡', 'ì—ì´ì „íŠ¸', 'ìµœì í™”', 'ê°•í™”í•™ìŠµ'];
let categoryApplications = {};
let selectedApplications = [];
let currentCategory = '';

async function loadCategories() {
    showLoading();
    try {
        // AI ì¹´í…Œê³ ë¦¬ë³„ ì§€ì›ì„œ ìˆ˜ ë¡œë“œ
        const response = await apiFetch('/api/applications');
        if (response.ok) {
            const applications = await response.json();
            
            // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í™”
            categoryApplications = {};
            aiCategories.forEach(cat => {
                categoryApplications[cat] = applications.filter(app => 
                    app.ai_category_primary === cat
                );
            });
            
            renderCategories();
        } else {
            showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error loading data:', error);
        showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    } finally {
        hideLoading();
    }
}

function renderCategories() {
    const tbody = document.getElementById('categories-tbody');
    tbody.innerHTML = '';

    aiCategories.forEach(category => {
        const apps = categoryApplications[category] || [];
        const row = `
            <tr>
                <td>
                    <span class="badge badge-category">${category}</span>
                </td>
                <td>${apps.length}ê°œ</td>
                <td>${getCategoryDescription(category)}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openCompareModal('${category}')" 
                            ${apps.length < 2 ? 'disabled' : ''}>
                        <i class="fas fa-balance-scale"></i> ì§€ì›ì„œ ë¹„êµ
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function getCategoryDescription(category) {
    const descriptions = {
        'ì˜ˆì¸¡': 'ë¯¸ë˜ ê°’ ì˜ˆì¸¡, ìˆ˜ìš” ì˜ˆì¸¡, íŠ¸ë Œë“œ ë¶„ì„',
        'ë¶„ë¥˜': 'ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ë¶„ë¥˜, ë¶ˆëŸ‰ ê²€ì¶œ, ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜',
        'ì±—ë´‡': 'ëŒ€í™”í˜• ì¸í„°í˜ì´ìŠ¤, ìë™ ì‘ë‹µ, Q&A',
        'ì—ì´ì „íŠ¸': 'ììœ¨ ì˜ì‚¬ê²°ì •, ë³µì¡í•œ ì‘ì—… ìë™í™”',
        'ìµœì í™”': 'ìì› ìµœì í™”, ìŠ¤ì¼€ì¤„ë§, ê²½ë¡œ ìµœì í™”',
        'ê°•í™”í•™ìŠµ': 'í•™ìŠµ ê¸°ë°˜ ì˜ì‚¬ê²°ì •, ì‹œë®¬ë ˆì´ì…˜ ìµœì í™”'
    };
    return descriptions[category] || '';
}

function openCompareModal(category) {
    currentCategory = category;
    selectedApplications = [];
    document.getElementById('compare-modal-title').textContent = `${category} ì¹´í…Œê³ ë¦¬ ì§€ì›ì„œ ë¹„êµ`;
    document.getElementById('compare-modal').style.display = 'flex';
    document.getElementById('comparison-result').style.display = 'none';
    renderApplicationsList();
}

function closeCompareModal() {
    document.getElementById('compare-modal').style.display = 'none';
    selectedApplications = [];
    currentCategory = '';
}

function renderApplicationsList() {
    const apps = categoryApplications[currentCategory] || [];
    const container = document.getElementById('applications-list');
    
    if (apps.length === 0) {
        container.innerHTML = '<div class="text-center p-4">ì´ ì¹´í…Œê³ ë¦¬ì— ì§€ì›ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    container.innerHTML = apps.map(app => `
        <div class="application-card ${selectedApplications.includes(app.id) ? 'selected' : ''}" 
             onclick="toggleSelection(${app.id})">
            <div class="app-header">
                <input type="checkbox" ${selectedApplications.includes(app.id) ? 'checked' : ''} 
                       onclick="event.stopPropagation(); toggleSelection(${app.id})">
                <span class="badge badge-grade-${app.ai_grade || 'B'}">${app.ai_grade || 'N/A'}</span>
            </div>
            <h4>${app.subject}</h4>
            <div class="app-info">
                <span><i class="fas fa-building"></i> ${app.division || 'N/A'}</span>
                <span><i class="fas fa-users"></i> ${app.participant_count || 0}ëª…</span>
            </div>
            <div class="app-summary">
                ${app.pain_point ? app.pain_point.substring(0, 100) + '...' : 'Pain Point ì—†ìŒ'}
            </div>
        </div>
    `).join('');
    
    updateSelectionCount();
}

function toggleSelection(appId) {
    const index = selectedApplications.indexOf(appId);
    
    if (index > -1) {
        selectedApplications.splice(index, 1);
    } else {
        if (selectedApplications.length >= 3) {
            showError('ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            return;
        }
        selectedApplications.push(appId);
    }
    
    renderApplicationsList();
}

function updateSelectionCount() {
    document.getElementById('selection-count').textContent = `(${selectedApplications.length}/3)`;
    document.getElementById('compare-btn').disabled = selectedApplications.length < 2;
}

async function showComparison() {
    if (selectedApplications.length < 2) {
        showError('ìµœì†Œ 2ê°œì˜ ì§€ì›ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì„ íƒëœ ì§€ì›ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const apps = categoryApplications[currentCategory].filter(app => 
        selectedApplications.includes(app.id)
    );
    
    // ë¹„êµ ê²°ê³¼ í‘œì‹œ
    document.querySelector('.selection-area').style.display = 'none';
    document.querySelector('.compare-actions').style.display = 'none';
    document.getElementById('comparison-result').style.display = 'block';
    
    renderComparison(apps);
}

function renderComparison(apps) {
    const container = document.getElementById('comparison-content');
    
    let html = `
        <div class="comparison-table-wrapper">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th class="sticky-col">ë¹„êµ í•­ëª©</th>
                        ${apps.map((app, idx) => `
                            <th>ì§€ì›ì„œ ${idx + 1}</th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <tr class="section-header">
                        <td class="sticky-col" colspan="${apps.length + 1}">ğŸ“‹ ê¸°ë³¸ ì •ë³´</td>
                    </tr>
                    <tr>
                        <td class="sticky-col">ê³¼ì œëª…</td>
                        ${apps.map(app => `<td><strong>${app.subject}</strong></td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ì‚¬ì—…ë¶€</td>
                        ${apps.map(app => `<td>${app.division || '-'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ë¶€ì„œ</td>
                        ${apps.map(app => `<td>${app.department_name || '-'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ì°¸ì—¬ ì¸ì›</td>
                        ${apps.map(app => `<td>${app.participant_count || 0}ëª…</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">AI ë“±ê¸‰</td>
                        ${apps.map(app => `<td><span class="badge badge-grade-${app.ai_grade || 'B'}">${app.ai_grade || 'N/A'}</span></td>`).join('')}
                    </tr>
                    
                    <!-- ë¬¸ì œ ë° í•´ê²°ë°©ì•ˆ -->
                    <tr class="section-header">
                        <td class="sticky-col" colspan="${apps.length + 1}">ğŸ¯ ë¬¸ì œ ë° í•´ê²°ë°©ì•ˆ</td>
                    </tr>
                    <tr>
                        <td class="sticky-col">Pain Point</td>
                        ${apps.map(app => `<td class="text-cell">${app.pain_point || '-'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ê°œì„  ì•„ì´ë””ì–´</td>
                        ${apps.map(app => `<td class="text-cell">${app.improvement_idea || '-'}</td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ê¸°ëŒ€ íš¨ê³¼</td>
                        ${apps.map(app => `<td class="text-cell">${app.expected_effect || '-'}</td>`).join('')}
                    </tr>
                    
                    <!-- AI ìš”ì•½ -->
                    <tr class="section-header">
                        <td class="sticky-col" colspan="${apps.length + 1}">ğŸ¤– AI ìš”ì•½</td>
                    </tr>
                    <tr>
                        <td class="sticky-col">AI ê¸°ìˆ  ë¶„ë¥˜</td>
                        ${apps.map(app => `<td><span class="badge badge-category">${app.ai_category_primary || 'ë¶„ë¥˜'}</span></td>`).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">ê²½ì˜íš¨ê³¼</td>
                        ${apps.map(app => {
                            const detail = app.ai_evaluation_detail || {};
                            return `<td class="text-cell">${detail.business_impact || '-'}</td>`;
                        }).join('')}
                    </tr>
                    <tr>
                        <td class="sticky-col">êµ¬í˜„ ê°€ëŠ¥ì„±</td>
                        ${apps.map(app => {
                            const detail = app.ai_evaluation_detail || {};
                            return `<td class="text-cell">${detail.technical_feasibility || '-'}</td>`;
                        }).join('')}
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="comparison-actions-bottom">
            <button class="btn btn-secondary" onclick="resetComparison()">
                <i class="fas fa-redo"></i> ë‹¤ì‹œ ì„ íƒ
            </button>
            <button class="btn btn-primary" onclick="printComparison()">
                <i class="fas fa-print"></i> ì¸ì‡„
            </button>
        </div>
    `;
    
    container.innerHTML = html;
}

function resetComparison() {
    selectedApplications = [];
    document.querySelector('.selection-area').style.display = 'block';
    document.querySelector('.compare-actions').style.display = 'flex';
    document.getElementById('comparison-result').style.display = 'none';
    renderApplicationsList();
}

function printComparison() {
    window.print();
}

// Load categories on page load
document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
});
</script>

<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 1000;
    overflow-y: auto;
}

.modal-content {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    margin: 2rem auto;
}

.modal-large {
    max-width: 1200px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #64748b;
}

.close-btn:hover {
    color: #334155;
}

.modal-body {
    padding: 1.5rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

.badge-category {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 700;
}

/* ì§€ì›ì„œ ë¹„êµ ìŠ¤íƒ€ì¼ */
.compare-instructions {
    background: #f0f9ff;
    padding: 1rem;
    border-left: 4px solid #3b82f6;
    border-radius: 4px;
    margin-bottom: 1.5rem;
}

.compare-instructions p {
    margin: 0;
    color: #1e40af;
}

.selection-area h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

#selection-count {
    color: #667eea;
    font-weight: 700;
}

.applications-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.application-card {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
}

.application-card:hover {
    border-color: #667eea;
    box-shadow: 0 4px 6px rgba(102, 126, 234, 0.1);
}

.application-card.selected {
    border-color: #667eea;
    background: #f0f4ff;
}

.app-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.app-header input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.application-card h4 {
    margin: 0.75rem 0;
    font-size: 1rem;
    color: #1e293b;
    line-height: 1.4;
}

.app-info {
    display: flex;
    gap: 1rem;
    margin: 0.5rem 0;
    font-size: 0.85rem;
    color: #64748b;
}

.app-info i {
    margin-right: 0.25rem;
}

.app-summary {
    font-size: 0.85rem;
    color: #64748b;
    line-height: 1.5;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.compare-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e5e7eb;
}

.comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.comparison-header h3 {
    margin: 0;
}

.comparison-table-wrapper {
    overflow-x: auto;
    margin-bottom: 1.5rem;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.comparison-table th,
.comparison-table td {
    padding: 1rem;
    text-align: left;
    border: 1px solid #e2e8f0;
}

.comparison-table thead th {
    background: #f8fafc;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

.comparison-table .sticky-col {
    position: sticky;
    left: 0;
    background: #f8fafc;
    font-weight: 600;
    z-index: 5;
    min-width: 150px;
}

.comparison-table .section-header td {
    background: #667eea;
    color: white;
    font-weight: 700;
    font-size: 1rem;
}

.comparison-table .text-cell {
    max-width: 300px;
    white-space: pre-wrap;
    line-height: 1.6;
}

.comparison-actions-bottom {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e2e8f0;
}

/* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
@media print {
    .modal-header,
    .comparison-actions-bottom,
    .compare-actions {
        display: none !important;
    }
    
    .modal {
        background: white !important;
    }
    
    .modal-content {
        box-shadow: none !important;
        max-width: 100% !important;
    }
    
    .comparison-table {
        font-size: 0.75rem;
    }
    
    .comparison-table th,
    .comparison-table td {
        padding: 0.5rem;
    }
}
</style>
{% endblock %}
