{% extends "base.html" %}

{% block title %}데이터 동기화 - AI 과제 지원서 평가 시스템{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">데이터 동기화 및 AI 평가</h2>
            <p class="text-gray-500 mt-1">외부 시스템(Confluence)에서 지원서 데이터를 동기화하고 AI 자동 평가를 실행합니다.</p>
        </div>
    </div>

    <!-- 개별 페이지 동기화 -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-md mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fa-solid fa-circle-info text-blue-500"></i>
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm text-blue-700 font-medium mb-2">개별 페이지 동기화</p>
                <p class="text-sm text-blue-600 mb-3">Confluence Page ID를 입력하여 특정 지원서 1개만 동기화할 수 있습니다.</p>
                <div class="flex gap-2">
                    <input type="text" id="single-page-id" placeholder="Page ID 입력 (예: 123456789)" class="flex-1 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-blue-300 rounded-md p-2 bg-white">
                    <button onclick="handleSinglePageSync()" id="single-sync-btn" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors whitespace-nowrap">
                        <i class="fa-solid fa-download mr-2"></i> 동기화
                    </button>
                </div>
                <div id="single-sync-result" class="mt-3 hidden"></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 동기화 설정 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fa-solid fa-gears text-blue-500 mr-2"></i> 전체 동기화 설정
                </h3>
            </div>
            <div class="p-6">
                <form id="sync-form" onsubmit="handleSync(event)">
                    <div class="mb-4">
                        <label for="batch-id" class="block text-sm font-medium text-gray-700 mb-1">배치 ID</label>
                        <input type="text" id="batch-id" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2" placeholder="예: 2024-Q1, 2026-1차">
                        <p class="mt-1 text-sm text-gray-500">
                            Confluence에서 가져올 지원서 그룹 식별자입니다. 비워두면 모든 지원서를 동기화합니다.
                        </p>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="force-update" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="force-update" class="font-medium text-gray-700">강제 업데이트</label>
                                <p class="text-gray-500">이미 동기화된 데이터도 덮어쓰기로 다시 가져옵니다.</p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="sync-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <i class="fa-solid fa-rotate mr-2"></i> 동기화 시작
                    </button>
                </form>
            </div>
        </div>

        <!-- 동기화 상태 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fa-solid fa-pulse text-green-500 mr-2"></i> 진행 상태
                </h3>
            </div>
            <div class="p-6">
                <div id="sync-status" class="min-h-[150px] flex items-center justify-center text-center">
                    <div class="text-gray-500">
                        <i class="fa-solid fa-arrow-left text-2xl mb-2 text-gray-300 block lg:hidden"></i>
                        <p>동기화를 시작하려면 "동기화 시작" 버튼을 클릭하세요.</p>
                    </div>
                </div>
                
                <div id="sync-progress" class="hidden mt-4">
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                                    진행중
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold inline-block text-blue-600" id="progress-text">
                                    0%
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                            <div class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI 자동 평가 섹션 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- AI 평가 설정 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fa-solid fa-robot text-purple-500 mr-2"></i> AI 자동 평가 설정
                </h3>
            </div>
            <div class="p-6">
                <form id="ai-eval-form" onsubmit="handleAIEvaluation(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">평가 대상</label>
                        <div class="space-y-2">
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="eval-pending" type="radio" name="eval-target" value="pending" checked class="focus:ring-purple-500 h-4 w-4 text-purple-600 border-gray-300">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="eval-pending" class="font-medium text-gray-700">미평가 지원서만</label>
                                    <p class="text-gray-500">아직 AI 평가가 완료되지 않은 지원서만 평가합니다.</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <div class="flex items-center h-5">
                                    <input id="eval-all" type="radio" name="eval-target" value="all" class="focus:ring-purple-500 h-4 w-4 text-purple-600 border-gray-300">
                                </div>
                                <div class="ml-3 text-sm">
                                    <label for="eval-all" class="font-medium text-gray-700">전체 재평가</label>
                                    <p class="text-gray-500">이미 평가된 지원서도 포함하여 전체를 재평가합니다.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <div class="flex">
                            <i class="fa-solid fa-triangle-exclamation text-yellow-600 mr-2 mt-0.5"></i>
                            <div class="text-sm text-yellow-800">
                                <p class="font-medium">주의사항</p>
                                <ul class="mt-1 list-disc list-inside text-xs space-y-0.5">
                                    <li>지원서 개수에 따라 시간이 오래 걸릴 수 있습니다</li>
                                    <li>LLM API 비용이 발생합니다</li>
                                    <li>평가 중에는 페이지를 닫지 마세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="ai-eval-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-colors">
                        <i class="fa-solid fa-robot mr-2"></i> AI 평가 시작
                    </button>
                </form>
            </div>
        </div>

        <!-- AI 평가 상태 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fa-solid fa-chart-line text-purple-500 mr-2"></i> 평가 진행 상태
                </h3>
            </div>
            <div class="p-6">
                <div id="ai-eval-status" class="min-h-[150px] flex items-center justify-center text-center">
                    <div class="text-gray-500">
                        <i class="fa-solid fa-arrow-left text-2xl mb-2 text-gray-300 block lg:hidden"></i>
                        <p>AI 평가를 시작하려면 "AI 평가 시작" 버튼을 클릭하세요.</p>
                    </div>
                </div>
                
                <div id="ai-eval-progress" class="hidden mt-4">
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-purple-600 bg-purple-200">
                                    평가중
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold inline-block text-purple-600" id="ai-progress-text">
                                    0 / 0
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-purple-200">
                            <div id="ai-progress-bar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-purple-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 최근 동기화 이력 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fa-solid fa-clock-rotate-left text-purple-500 mr-2"></i> 최근 동기화 이력
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">배치 ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">동기화 시각</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">성공</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">실패</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">총계</th>
                    </tr>
                </thead>
                <tbody id="sync-history-tbody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">이력이 없습니다.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function handleSync(event) {
    event.preventDefault();

    const batchId = document.getElementById('batch-id').value || null;
    const forceUpdate = document.getElementById('force-update').checked;

    const syncBtn = document.getElementById('sync-btn');
    const originalBtnContent = syncBtn.innerHTML;
    syncBtn.disabled = true;
    syncBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 동기화 중...';
    syncBtn.classList.add('opacity-75', 'cursor-not-allowed');

    const statusDiv = document.getElementById('sync-status');
    const progressDiv = document.getElementById('sync-progress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const progressText = document.getElementById('progress-text');
    
    statusDiv.innerHTML = `
        <div class="text-center text-blue-600">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
            <p class="font-medium">데이터 동기화가 진행 중입니다...</p>
            <p class="text-sm text-gray-500 mt-1">데이터 양에 따라 시간이 소요될 수 있습니다.</p>
        </div>
    `;
    
    progressDiv.classList.remove('hidden');
    // Simulate progress for UX
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        }
    }, 500);

    try {
        const response = await apiFetch('/api/applications/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                batch_id: batchId,
                force_update: forceUpdate
            })
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';

        if (response.ok) {
            const result = await response.json();
            
            statusDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 w-full text-left">
                    <h4 class="text-lg font-bold text-green-800 mb-2 flex items-center">
                        <i class="fa-solid fa-check-circle mr-2"></i> 동기화 완료
                    </h4>
                    <div class="space-y-1 text-green-700">
                        <p>총 처리: <span class="font-bold">${result.total_processed || 0}</span>건</p>
                        <p>성공: <span class="font-bold">${result.success_count || 0}</span>건</p>
                        <p>실패: <span class="font-bold text-red-600">${result.error_count || 0}</span>건</p>
                    </div>
                    ${result.errors && result.errors.length > 0 ? `
                        <div class="mt-4 border-t border-green-200 pt-3">
                            <details class="text-sm">
                                <summary class="font-medium text-red-600 cursor-pointer hover:underline">오류 상세 보기</summary>
                                <ul class="mt-2 list-disc list-inside text-red-700 pl-2 space-y-1 max-h-40 overflow-y-auto">
                                    ${result.errors.map(err => `<li>${err}</li>`).join('')}
                                </ul>
                            </details>
                        </div>
                    ` : ''}
                </div>
            `;

            // Reload history
            await loadSyncHistory();
        } else {
            const error = await response.json();
            statusDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 w-full text-left">
                    <h4 class="text-lg font-bold text-red-800 mb-2 flex items-center">
                        <i class="fa-solid fa-circle-exclamation mr-2"></i> 동기화 실패
                    </h4>
                    <p class="text-red-700">${error.detail || '알 수 없는 오류가 발생했습니다.'}</p>
                </div>
            `;
        }
    } catch (error) {
        clearInterval(progressInterval);
        console.error('Error syncing:', error);
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 w-full text-left">
                <h4 class="text-lg font-bold text-red-800 mb-2 flex items-center">
                    <i class="fa-solid fa-circle-exclamation mr-2"></i> 시스템 오류
                </h4>
                <p class="text-red-700">서버와 통신 중 오류가 발생했습니다.</p>
            </div>
        `;
    } finally {
        syncBtn.disabled = false;
        syncBtn.innerHTML = originalBtnContent;
        syncBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        
        // Hide progress bar after delay
        setTimeout(() => {
            progressDiv.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
        }, 3000);
    }
}

async function loadSyncHistory() {
    // This would load actual sync history from backend
    // For now, we'll show a placeholder
    const tbody = document.getElementById('sync-history-tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">동기화 이력 기능은 준비 중입니다.</td></tr>';
}

async function handleAIEvaluation(event) {
    event.preventDefault();

    const evalTarget = document.querySelector('input[name="eval-target"]:checked').value;
    const forceReEvaluate = evalTarget === 'all';

    const evalBtn = document.getElementById('ai-eval-btn');
    const originalBtnContent = evalBtn.innerHTML;
    evalBtn.disabled = true;
    evalBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> AI 평가 중...';
    evalBtn.classList.add('opacity-75', 'cursor-not-allowed');

    const statusDiv = document.getElementById('ai-eval-status');
    const progressDiv = document.getElementById('ai-eval-progress');
    const progressBar = document.getElementById('ai-progress-bar');
    const progressText = document.getElementById('ai-progress-text');
    
    statusDiv.innerHTML = `
        <div class="text-center text-purple-600">
            <i class="fa-solid fa-robot fa-bounce text-4xl mb-4"></i>
            <p class="font-medium">AI 평가가 진행 중입니다...</p>
            <p class="text-sm text-gray-500 mt-1">LLM API를 통해 지원서를 분석하고 있습니다.</p>
        </div>
    `;
    
    progressDiv.classList.remove('hidden');
    progressBar.style.width = '0%';
    progressText.textContent = '0 / 0';

    try {
        const response = await apiFetch('/api/evaluations/run-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                force_re_evaluate: forceReEvaluate,
                application_ids: null
            })
        });

        if (response.ok) {
            const result = await response.json();
            
            const total = result.success_count + result.fail_count;
            const successRate = total > 0 ? Math.round((result.success_count / total) * 100) : 0;
            
            progressBar.style.width = '100%';
            progressText.textContent = `${result.success_count} / ${total}`;
            
            statusDiv.innerHTML = `
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 w-full text-left">
                    <h4 class="text-lg font-bold text-purple-800 mb-2 flex items-center">
                        <i class="fa-solid fa-check-circle mr-2"></i> AI 평가 완료
                    </h4>
                    <div class="space-y-1 text-purple-700">
                        <p>총 평가: <span class="font-bold">${total}</span>건</p>
                        <p>성공: <span class="font-bold text-green-600">${result.success_count}</span>건 (${successRate}%)</p>
                        <p>실패: <span class="font-bold text-red-600">${result.fail_count}</span>건</p>
                    </div>
                    ${result.error_messages && result.error_messages.length > 0 ? `
                        <div class="mt-4 border-t border-purple-200 pt-3">
                            <details class="text-sm">
                                <summary class="font-medium text-red-600 cursor-pointer hover:underline">오류 상세 보기</summary>
                                <ul class="mt-2 list-disc list-inside text-red-700 pl-2 space-y-1 max-h-40 overflow-y-auto">
                                    ${result.error_messages.map(err => `<li>${err}</li>`).join('')}
                                </ul>
                            </details>
                        </div>
                    ` : ''}
                    <div class="mt-4 pt-3 border-t border-purple-200">
                        <a href="/applications" class="inline-flex items-center text-sm font-medium text-purple-600 hover:text-purple-800">
                            <i class="fa-solid fa-arrow-right mr-1"></i> 평가 결과 보러가기
                        </a>
                    </div>
                </div>
            `;
        } else {
            const error = await response.json();
            statusDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 w-full text-left">
                    <h4 class="text-lg font-bold text-red-800 mb-2 flex items-center">
                        <i class="fa-solid fa-circle-exclamation mr-2"></i> AI 평가 실패
                    </h4>
                    <p class="text-red-700">${error.detail || '알 수 없는 오류가 발생했습니다.'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error in AI evaluation:', error);
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 w-full text-left">
                <h4 class="text-lg font-bold text-red-800 mb-2 flex items-center">
                    <i class="fa-solid fa-circle-exclamation mr-2"></i> 시스템 오류
                </h4>
                <p class="text-red-700">서버와 통신 중 오류가 발생했습니다.</p>
                <p class="text-sm text-gray-600 mt-1">${error.message}</p>
            </div>
        `;
    } finally {
        evalBtn.disabled = false;
        evalBtn.innerHTML = originalBtnContent;
        evalBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        
        // Hide progress bar after delay
        setTimeout(() => {
            progressDiv.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0 / 0';
        }, 5000);
    }
}

// 개별 페이지 동기화
async function handleSinglePageSync() {
    const pageId = document.getElementById('single-page-id').value.trim();

    if (!pageId) {
        alert('Page ID를 입력해주세요.');
        return;
    }

    const btn = document.getElementById('single-sync-btn');
    const resultDiv = document.getElementById('single-sync-result');
    const originalBtnContent = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 동기화 중...';
    btn.classList.add('opacity-75');

    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = `
        <div class="bg-white border border-blue-200 rounded p-3 text-blue-700 text-sm">
            <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Confluence에서 데이터를 가져오는 중...
        </div>
    `;

    try {
        const response = await apiFetch('/api/applications/sync/single', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                page_id: pageId,
                force_update: true
            })
        });

        if (response.ok) {
            const result = await response.json();
            const action = result.result.action === 'created' ? '생성' : '업데이트';

            resultDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded p-3">
                    <div class="flex items-start">
                        <i class="fa-solid fa-check-circle text-green-600 mr-2 mt-0.5"></i>
                        <div class="text-sm text-green-800">
                            <p class="font-medium">동기화 성공!</p>
                            <p class="mt-1">지원서가 ${action}되었습니다. (ID: ${result.result.application_id})</p>
                            <a href="/applications/${result.result.application_id}" class="inline-flex items-center text-green-700 hover:text-green-900 font-medium mt-2">
                                <i class="fa-solid fa-arrow-right mr-1"></i> 지원서 보기
                            </a>
                        </div>
                    </div>
                </div>
            `;

            // Clear input
            document.getElementById('single-page-id').value = '';
        } else {
            const error = await response.json();
            resultDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded p-3">
                    <div class="flex items-start">
                        <i class="fa-solid fa-circle-exclamation text-red-600 mr-2 mt-0.5"></i>
                        <div class="text-sm text-red-800">
                            <p class="font-medium">동기화 실패</p>
                            <p class="mt-1">${error.detail || '알 수 없는 오류가 발생했습니다.'}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error syncing single page:', error);
        resultDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded p-3">
                <div class="flex items-start">
                    <i class="fa-solid fa-circle-exclamation text-red-600 mr-2 mt-0.5"></i>
                    <div class="text-sm text-red-800">
                        <p class="font-medium">시스템 오류</p>
                        <p class="mt-1">서버와 통신 중 오류가 발생했습니다.</p>
                    </div>
                </div>
            </div>
        `;
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnContent;
        btn.classList.remove('opacity-75');
    }
}

// Load history on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSyncHistory();
});
</script>
{% endblock %}
