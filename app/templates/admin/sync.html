{% extends "base.html" %}

{% block title %}데이터 동기화 - AI 과제 지원서 평가 시스템{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">데이터 동기화</h2>
            <p class="text-gray-500 mt-1">외부 시스템(Confluence)에서 지원서 데이터를 동기화합니다.</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- 동기화 설정 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fa-solid fa-gears text-blue-500 mr-2"></i> 동기화 설정
                </h3>
            </div>
            <div class="p-6">
                <form id="sync-form" onsubmit="handleSync(event)">
                    <div class="mb-4">
                        <label for="batch-id" class="block text-sm font-medium text-gray-700 mb-1">배치 ID</label>
                        <input type="text" id="batch-id" class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md p-2" placeholder="예: 2024-Q1, 2026-1차">
                        <p class="mt-1 text-sm text-gray-500">
                            Confluence에서 가져올 지원서 그룹 식별자입니다. 비워두면 모든 지원서를 동기화합니다.
                        </p>
                    </div>

                    <div class="mb-6">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="force-update" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="force-update" class="font-medium text-gray-700">강제 업데이트</label>
                                <p class="text-gray-500">이미 동기화된 데이터도 덮어쓰기로 다시 가져옵니다.</p>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="sync-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <i class="fa-solid fa-rotate mr-2"></i> 동기화 시작
                    </button>
                </form>
            </div>
        </div>

        <!-- 동기화 상태 -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fa-solid fa-pulse text-green-500 mr-2"></i> 진행 상태
                </h3>
            </div>
            <div class="p-6">
                <div id="sync-status" class="min-h-[150px] flex items-center justify-center text-center">
                    <div class="text-gray-500">
                        <i class="fa-solid fa-arrow-left text-2xl mb-2 text-gray-300 block lg:hidden"></i>
                        <p>동기화를 시작하려면 "동기화 시작" 버튼을 클릭하세요.</p>
                    </div>
                </div>
                
                <div id="sync-progress" class="hidden mt-4">
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between">
                            <div>
                                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-blue-600 bg-blue-200">
                                    진행중
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-xs font-semibold inline-block text-blue-600" id="progress-text">
                                    0%
                                </span>
                            </div>
                        </div>
                        <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-blue-200">
                            <div class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-blue-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 최근 동기화 이력 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <i class="fa-solid fa-clock-rotate-left text-purple-500 mr-2"></i> 최근 동기화 이력
            </h3>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">배치 ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">동기화 시각</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">성공</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">실패</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">총계</th>
                    </tr>
                </thead>
                <tbody id="sync-history-tbody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">이력이 없습니다.</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
async function handleSync(event) {
    event.preventDefault();

    const batchId = document.getElementById('batch-id').value || null;
    const forceUpdate = document.getElementById('force-update').checked;

    const syncBtn = document.getElementById('sync-btn');
    const originalBtnContent = syncBtn.innerHTML;
    syncBtn.disabled = true;
    syncBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> 동기화 중...';
    syncBtn.classList.add('opacity-75', 'cursor-not-allowed');

    const statusDiv = document.getElementById('sync-status');
    const progressDiv = document.getElementById('sync-progress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    const progressText = document.getElementById('progress-text');
    
    statusDiv.innerHTML = `
        <div class="text-center text-blue-600">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4"></i>
            <p class="font-medium">데이터 동기화가 진행 중입니다...</p>
            <p class="text-sm text-gray-500 mt-1">데이터 양에 따라 시간이 소요될 수 있습니다.</p>
        </div>
    `;
    
    progressDiv.classList.remove('hidden');
    // Simulate progress for UX
    let progress = 0;
    const progressInterval = setInterval(() => {
        if (progress < 90) {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
        }
    }, 500);

    try {
        const response = await apiFetch('/api/applications/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                batch_id: batchId,
                force_update: forceUpdate
            })
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = '100%';

        if (response.ok) {
            const result = await response.json();
            
            statusDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 w-full text-left">
                    <h4 class="text-lg font-bold text-green-800 mb-2 flex items-center">
                        <i class="fa-solid fa-check-circle mr-2"></i> 동기화 완료
                    </h4>
                    <div class="space-y-1 text-green-700">
                        <p>총 처리: <span class="font-bold">${result.total_processed || 0}</span>건</p>
                        <p>성공: <span class="font-bold">${result.success_count || 0}</span>건</p>
                        <p>실패: <span class="font-bold text-red-600">${result.error_count || 0}</span>건</p>
                    </div>
                    ${result.errors && result.errors.length > 0 ? `
                        <div class="mt-4 border-t border-green-200 pt-3">
                            <details class="text-sm">
                                <summary class="font-medium text-red-600 cursor-pointer hover:underline">오류 상세 보기</summary>
                                <ul class="mt-2 list-disc list-inside text-red-700 pl-2 space-y-1 max-h-40 overflow-y-auto">
                                    ${result.errors.map(err => `<li>${err}</li>`).join('')}
                                </ul>
                            </details>
                        </div>
                    ` : ''}
                </div>
            `;

            // Reload history
            await loadSyncHistory();
        } else {
            const error = await response.json();
            statusDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 w-full text-left">
                    <h4 class="text-lg font-bold text-red-800 mb-2 flex items-center">
                        <i class="fa-solid fa-circle-exclamation mr-2"></i> 동기화 실패
                    </h4>
                    <p class="text-red-700">${error.detail || '알 수 없는 오류가 발생했습니다.'}</p>
                </div>
            `;
        }
    } catch (error) {
        clearInterval(progressInterval);
        console.error('Error syncing:', error);
        statusDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 w-full text-left">
                <h4 class="text-lg font-bold text-red-800 mb-2 flex items-center">
                    <i class="fa-solid fa-circle-exclamation mr-2"></i> 시스템 오류
                </h4>
                <p class="text-red-700">서버와 통신 중 오류가 발생했습니다.</p>
            </div>
        `;
    } finally {
        syncBtn.disabled = false;
        syncBtn.innerHTML = originalBtnContent;
        syncBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        
        // Hide progress bar after delay
        setTimeout(() => {
            progressDiv.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
        }, 3000);
    }
}

async function loadSyncHistory() {
    // This would load actual sync history from backend
    // For now, we'll show a placeholder
    const tbody = document.getElementById('sync-history-tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">동기화 이력 기능은 준비 중입니다.</td></tr>';
}

// Load history on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSyncHistory();
});
</script>
{% endblock %}
